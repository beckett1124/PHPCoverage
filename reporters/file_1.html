

<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<style>
.line_unexcutable{
	background-color:#F0F0F0;
}

.line_covered{
	background-color:#B4EEB4;
}

.line_uncovered{
	background-color:#FFFAF0;
}

.keyword{
	font-weight:bold;
	color:blue;
}

.line_num{
	font-size:0.8em;
}

</style>
</head>
<body>
	<table><tr class="line_uncovered"><td class="line_num">0</td><td ><?php
</td></tr><tr class="line_unexcutable"><td class="line_num">1</td><td >/**
</td></tr><tr class="line_unexcutable"><td class="line_num">2</td><td >&nbsp;*&nbsp;User&nbsp;:&nbsp;wujian
</td></tr><tr class="line_unexcutable"><td class="line_num">3</td><td >&nbsp;*&nbsp;Notice&nbsp;:&nbsp;用户优惠券查询
</td></tr><tr class="line_unexcutable"><td class="line_num">4</td><td >&nbsp;*/
</td></tr><tr class="line_uncovered"><td class="line_num">5</td><td ><label class="keyword">namespace&nbsp;</label>Models;
</td></tr><tr class="line_unexcutable"><td class="line_num">6</td><td >
</td></tr><tr class="line_uncovered"><td class="line_num">7</td><td ><label class="keyword">use&nbsp;</label>\Phalcon\Di;
</td></tr><tr class="line_uncovered"><td class="line_num">8</td><td ><label class="keyword">use&nbsp;</label>Phalcon\Mvc\Model\Resultset\Simple&nbsp;<label class="keyword">as&nbsp;</label>Resultset;
</td></tr><tr class="line_covered"><td class="line_num">9</td><td><label class="keyword">use&nbsp;</label>Models\NoticeModel;
</td></tr><tr class="line_uncovered"><td class="line_num">10</td><td ><label class="keyword">use&nbsp;</label>Models\ScenarioModel;
</td></tr><tr class="line_uncovered"><td class="line_num">11</td><td ><label class="keyword">use&nbsp;</label>Models\CouponModel;
</td></tr><tr class="line_unexcutable"><td class="line_num">12</td><td >
</td></tr><tr class="line_uncovered"><td class="line_num">13</td><td ><label class="keyword">class&nbsp;</label>UserCouponModel&nbsp;<label class="keyword">extends&nbsp;</label>BaseModel
</td></tr><tr class="line_unexcutable"><td class="line_num">14</td><td >{
</td></tr><tr class="line_covered"><td class="line_num">15</td><td>&nbsp;&nbsp;&nbsp;&nbsp;<label class="keyword">public&nbsp;</label><label class="keyword">static&nbsp;</label>$tableName&nbsp;=&nbsp;'cp_user_coupons';
</td></tr><tr class="line_unexcutable"><td class="line_num">16</td><td >
</td></tr><tr class="line_covered"><td class="line_num">17</td><td>&nbsp;&nbsp;&nbsp;&nbsp;<label class="keyword">CONST&nbsp;</label>CACHE_CONNECTION&nbsp;=&nbsp;'cache_coupon';
</td></tr><tr class="line_unexcutable"><td class="line_num">18</td><td >
</td></tr><tr class="line_unexcutable"><td class="line_num">19</td><td >&nbsp;&nbsp;&nbsp;&nbsp;<label class="keyword">CONST&nbsp;</label>CACHE_KEY_USER_COUPONS&nbsp;=&nbsp;'user_coupon:%s:%s';&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;userId:status
</td></tr><tr class="line_unexcutable"><td class="line_num">20</td><td >&nbsp;&nbsp;&nbsp;&nbsp;<label class="keyword">CONST&nbsp;</label>CACHE_KEY_USER_COUPON_BY_ORDERID&nbsp;=&nbsp;'user_coupon_by_orderid:%s';&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;userId:orderId
</td></tr><tr class="line_unexcutable"><td class="line_num">21</td><td >&nbsp;&nbsp;&nbsp;&nbsp;<label class="keyword">CONST&nbsp;</label>CACHE_KEY_USER_COUPON_BY_SCENARIO_VALUE&nbsp;=&nbsp;'user_coupon_by_scenarid_value:%s';&nbsp;&nbsp;&nbsp;//&nbsp;userId:code:value
</td></tr><tr class="line_unexcutable"><td class="line_num">22</td><td >&nbsp;&nbsp;&nbsp;&nbsp;<label class="keyword">CONST&nbsp;</label>CACHE_KEY_USER_COUPON_BY_SCENARIO_UID&nbsp;=&nbsp;'user_coupon_by_scenarid_uid:%s';&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;userId:code
</td></tr><tr class="line_unexcutable"><td class="line_num">23</td><td >
</td></tr><tr class="line_uncovered"><td class="line_num">24</td><td >&nbsp;&nbsp;&nbsp;&nbsp;<label class="keyword">CONST&nbsp;</label>K_USED&nbsp;=&nbsp;'USED';
</td></tr><tr class="line_uncovered"><td class="line_num">25</td><td >&nbsp;&nbsp;&nbsp;&nbsp;<label class="keyword">CONST&nbsp;</label>K_ACTIVED&nbsp;=&nbsp;'ACTIVED';
</td></tr><tr class="line_uncovered"><td class="line_num">26</td><td >&nbsp;&nbsp;&nbsp;&nbsp;<label class="keyword">CONST&nbsp;</label>K_STARTED&nbsp;=&nbsp;'STARTED';
</td></tr><tr class="line_uncovered"><td class="line_num">27</td><td >&nbsp;&nbsp;&nbsp;&nbsp;<label class="keyword">CONST&nbsp;</label>K_FINISHED&nbsp;=&nbsp;'FINISHED';
</td></tr><tr class="line_unexcutable"><td class="line_num">28</td><td >
</td></tr><tr class="line_uncovered"><td class="line_num">29</td><td >&nbsp;&nbsp;&nbsp;&nbsp;<label class="keyword">CONST&nbsp;</label>V_YES&nbsp;=&nbsp;1;
</td></tr><tr class="line_uncovered"><td class="line_num">30</td><td >&nbsp;&nbsp;&nbsp;&nbsp;<label class="keyword">CONST&nbsp;</label>V_NO&nbsp;=&nbsp;0;
</td></tr><tr class="line_uncovered"><td class="line_num">31</td><td >&nbsp;&nbsp;&nbsp;&nbsp;<label class="keyword">CONST&nbsp;</label>V_NONEED&nbsp;=&nbsp;2;
</td></tr><tr class="line_unexcutable"><td class="line_num">32</td><td >
</td></tr><tr class="line_uncovered"><td class="line_num">33</td><td >&nbsp;&nbsp;&nbsp;&nbsp;<label class="keyword">private&nbsp;</label><label class="keyword">static&nbsp;</label>$real_keys&nbsp;=&nbsp;[
</td></tr><tr class="line_uncovered"><td class="line_num">34</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'1012',
</td></tr><tr class="line_uncovered"><td class="line_num">35</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'1022'
</td></tr><tr class="line_uncovered"><td class="line_num">36</td><td >&nbsp;&nbsp;&nbsp;&nbsp;];
</td></tr><tr class="line_unexcutable"><td class="line_num">37</td><td >
</td></tr><tr class="line_unexcutable"><td class="line_num">38</td><td >&nbsp;&nbsp;&nbsp;&nbsp;/*<label class="keyword">private&nbsp;</label><label class="keyword">static&nbsp;</label>$sql_template&nbsp;=&nbsp;"SELECT&nbsp;
</td></tr><tr class="line_unexcutable"><td class="line_num">39</td><td >uc.id&nbsp;AS&nbsp;user_coupon_id,
</td></tr><tr class="line_unexcutable"><td class="line_num">40</td><td >uc.user_id,
</td></tr><tr class="line_unexcutable"><td class="line_num">41</td><td >uc.coupon_id,
</td></tr><tr class="line_unexcutable"><td class="line_num">42</td><td >uc.created_at,
</td></tr><tr class="line_unexcutable"><td class="line_num">43</td><td >uc.used,
</td></tr><tr class="line_unexcutable"><td class="line_num">44</td><td >uc.actived,
</td></tr><tr class="line_unexcutable"><td class="line_num">45</td><td >uc.scenario_code,
</td></tr><tr class="line_unexcutable"><td class="line_num">46</td><td >uc.scenario_value,
</td></tr><tr class="line_unexcutable"><td class="line_num">47</td><td >cp.name,
</td></tr><tr class="line_unexcutable"><td class="line_num">48</td><td >cp.description,
</td></tr><tr class="line_unexcutable"><td class="line_num">49</td><td >uc.order_id,
</td></tr><tr class="line_unexcutable"><td class="line_num">50</td><td >cp.cover,
</td></tr><tr class="line_unexcutable"><td class="line_num">51</td><td >cp.ttl,
</td></tr><tr class="line_unexcutable"><td class="line_num">52</td><td >cp.amount,
</td></tr><tr class="line_unexcutable"><td class="line_num">53</td><td >cp.is_discount,
</td></tr><tr class="line_unexcutable"><td class="line_num">54</td><td >cp.started_at,
</td></tr><tr class="line_unexcutable"><td class="line_num">55</td><td >cp.finished_at
</td></tr><tr class="line_unexcutable"><td class="line_num">56</td><td >FROM&nbsp;cp_user_coupons&nbsp;AS&nbsp;uc&nbsp;
</td></tr><tr class="line_unexcutable"><td class="line_num">57</td><td >INNER&nbsp;JOIN&nbsp;cp_coupon&nbsp;AS&nbsp;cp&nbsp;
</td></tr><tr class="line_unexcutable"><td class="line_num">58</td><td >ON&nbsp;uc.coupon_id&nbsp;=&nbsp;cp.id&nbsp;&nbsp;";*/
</td></tr><tr class="line_unexcutable"><td class="line_num">59</td><td >
</td></tr><tr class="line_uncovered"><td class="line_num">60</td><td >&nbsp;&nbsp;&nbsp;&nbsp;<label class="keyword">private&nbsp;</label><label class="keyword">static&nbsp;</label>$sql_template&nbsp;=&nbsp;"SELECT&nbsp;
</td></tr><tr class="line_uncovered"><td class="line_num">61</td><td >cp.id&nbsp;AS&nbsp;coupon_id,
</td></tr><tr class="line_uncovered"><td class="line_num">62</td><td >uc.id&nbsp;AS&nbsp;user_coupon_id,
</td></tr><tr class="line_uncovered"><td class="line_num">63</td><td >uc.user_id,
</td></tr><tr class="line_uncovered"><td class="line_num">64</td><td >uc.coupon_id,
</td></tr><tr class="line_uncovered"><td class="line_num">65</td><td >uc.created_at,
</td></tr><tr class="line_uncovered"><td class="line_num">66</td><td >uc.used,
</td></tr><tr class="line_uncovered"><td class="line_num">67</td><td >uc.actived,
</td></tr><tr class="line_uncovered"><td class="line_num">68</td><td >uc.scenario_code,
</td></tr><tr class="line_uncovered"><td class="line_num">69</td><td >uc.scenario_value,
</td></tr><tr class="line_uncovered"><td class="line_num">70</td><td >uc.order_id
</td></tr><tr class="line_uncovered"><td class="line_num">71</td><td >FROM&nbsp;cp_user_coupons&nbsp;AS&nbsp;uc&nbsp;
</td></tr><tr class="line_uncovered"><td class="line_num">72</td><td >INNER&nbsp;JOIN&nbsp;cp_coupon&nbsp;AS&nbsp;cp&nbsp;
</td></tr><tr class="line_uncovered"><td class="line_num">73</td><td >ON&nbsp;uc.coupon_id&nbsp;=&nbsp;cp.id&nbsp;&nbsp;";
</td></tr><tr class="line_unexcutable"><td class="line_num">74</td><td >
</td></tr><tr class="line_uncovered"><td class="line_num">75</td><td >&nbsp;&nbsp;&nbsp;&nbsp;<label class="keyword">protected&nbsp;</label><label class="keyword">static&nbsp;</label>$_inst&nbsp;=&nbsp;NULL;
</td></tr><tr class="line_unexcutable"><td class="line_num">76</td><td >
</td></tr><tr class="line_uncovered"><td class="line_num">77</td><td >&nbsp;&nbsp;&nbsp;&nbsp;<label class="keyword">public&nbsp;</label><label class="keyword">function&nbsp;</label>initialize()
</td></tr><tr class="line_unexcutable"><td class="line_num">78</td><td >&nbsp;&nbsp;&nbsp;&nbsp;{
</td></tr><tr class="line_uncovered"><td class="line_num">79</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this->setReadConnectionService('db_coupon_slave');
</td></tr><tr class="line_uncovered"><td class="line_num">80</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this->setWriteConnectionService('db_coupon');
</td></tr><tr class="line_unexcutable"><td class="line_num">81</td><td >&nbsp;&nbsp;&nbsp;&nbsp;}
</td></tr><tr class="line_unexcutable"><td class="line_num">82</td><td >
</td></tr><tr class="line_uncovered"><td class="line_num">83</td><td >&nbsp;&nbsp;&nbsp;&nbsp;<label class="keyword">public&nbsp;</label><label class="keyword">function&nbsp;</label>getSource()
</td></tr><tr class="line_unexcutable"><td class="line_num">84</td><td >&nbsp;&nbsp;&nbsp;&nbsp;{
</td></tr><tr class="line_uncovered"><td class="line_num">85</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<label class="keyword">return&nbsp;</label>'cp_user_coupons';
</td></tr><tr class="line_unexcutable"><td class="line_num">86</td><td >&nbsp;&nbsp;&nbsp;&nbsp;}
</td></tr><tr class="line_unexcutable"><td class="line_num">87</td><td >
</td></tr><tr class="line_uncovered"><td class="line_num">88</td><td >&nbsp;&nbsp;&nbsp;&nbsp;<label class="keyword">public&nbsp;</label><label class="keyword">static&nbsp;</label><label class="keyword">function&nbsp;</label>getInstance()
</td></tr><tr class="line_unexcutable"><td class="line_num">89</td><td >&nbsp;&nbsp;&nbsp;&nbsp;{
</td></tr><tr class="line_covered"><td class="line_num">90</td><td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<label class="keyword">if&nbsp;</label>(self::$_inst&nbsp;==&nbsp;NULL)&nbsp;{
</td></tr><tr class="line_covered"><td class="line_num">91</td><td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self::$_inst&nbsp;=&nbsp;<label class="keyword">new&nbsp;</label>UserCouponModel();
</td></tr><tr class="line_unexcutable"><td class="line_num">92</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
</td></tr><tr class="line_covered"><td class="line_num">93</td><td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<label class="keyword">return&nbsp;</label>self::$_inst;
</td></tr><tr class="line_unexcutable"><td class="line_num">94</td><td >&nbsp;&nbsp;&nbsp;&nbsp;}
</td></tr><tr class="line_unexcutable"><td class="line_num">95</td><td >
</td></tr><tr class="line_unexcutable"><td class="line_num">96</td><td >&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;!&nbsp;清除指定UID的所有優惠券
</td></tr><tr class="line_uncovered"><td class="line_num">97</td><td >&nbsp;&nbsp;&nbsp;&nbsp;<label class="keyword">public&nbsp;</label><label class="keyword">static&nbsp;</label><label class="keyword">function&nbsp;</label>clearUserCache($userId)
</td></tr><tr class="line_unexcutable"><td class="line_num">98</td><td >&nbsp;&nbsp;&nbsp;&nbsp;{
</td></tr><tr class="line_unexcutable"><td class="line_num">99</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;清空根據用戶UID查詢的緩存
</td></tr><tr class="line_uncovered"><td class="line_num">100</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<label class="keyword">foreach&nbsp;</label>(self::$real_keys&nbsp;<label class="keyword">as&nbsp;</label>$k&nbsp;=>&nbsp;$status)&nbsp;{
</td></tr><tr class="line_uncovered"><td class="line_num">101</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$cacheKey&nbsp;=&nbsp;sprintf(self::CACHE_KEY_USER_COUPONS,&nbsp;$userId,&nbsp;$status);
</td></tr><tr class="line_uncovered"><td class="line_num">102</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Di::getDefault()->get(self::CACHE_CONNECTION)->destroy($cacheKey);
</td></tr><tr class="line_unexcutable"><td class="line_num">103</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
</td></tr><tr class="line_unexcutable"><td class="line_num">104</td><td >
</td></tr><tr class="line_unexcutable"><td class="line_num">105</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;清空根據場景回溯的緩存
</td></tr><tr class="line_uncovered"><td class="line_num">106</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Di::getDefault()->get(self::CACHE_CONNECTION)->destroy(sprintf(self::CACHE_KEY_USER_COUPON_BY_ORDERID,&nbsp;$userId));
</td></tr><tr class="line_uncovered"><td class="line_num">107</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Di::getDefault()->get(self::CACHE_CONNECTION)->destroy(sprintf(self::CACHE_KEY_USER_COUPON_BY_SCENARIO_VALUE,&nbsp;$userId));
</td></tr><tr class="line_uncovered"><td class="line_num">108</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Di::getDefault()->get(self::CACHE_CONNECTION)->destroy(sprintf(self::CACHE_KEY_USER_COUPON_BY_SCENARIO_UID,&nbsp;$userId));
</td></tr><tr class="line_unexcutable"><td class="line_num">109</td><td >&nbsp;&nbsp;&nbsp;&nbsp;}
</td></tr><tr class="line_unexcutable"><td class="line_num">110</td><td >
</td></tr><tr class="line_uncovered"><td class="line_num">111</td><td >&nbsp;&nbsp;&nbsp;&nbsp;<label class="keyword">private&nbsp;</label><label class="keyword">function&nbsp;</label>buildWheres($statusParams)
</td></tr><tr class="line_unexcutable"><td class="line_num">112</td><td >&nbsp;&nbsp;&nbsp;&nbsp;{
</td></tr><tr class="line_uncovered"><td class="line_num">113</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$wheres&nbsp;=&nbsp;'';
</td></tr><tr class="line_uncovered"><td class="line_num">114</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<label class="keyword">switch&nbsp;</label>($statusParams[self::K_USED])&nbsp;{
</td></tr><tr class="line_uncovered"><td class="line_num">115</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<label class="keyword">case&nbsp;</label>self::V_YES:
</td></tr><tr class="line_uncovered"><td class="line_num">116</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$wheres&nbsp;.=&nbsp;'uc.used&nbsp;=&nbsp;1';
</td></tr><tr class="line_uncovered"><td class="line_num">117</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;
</td></tr><tr class="line_uncovered"><td class="line_num">118</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<label class="keyword">case&nbsp;</label>self::V_NO:
</td></tr><tr class="line_uncovered"><td class="line_num">119</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$wheres&nbsp;.=&nbsp;'uc.used&nbsp;=&nbsp;0';
</td></tr><tr class="line_uncovered"><td class="line_num">120</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;
</td></tr><tr class="line_uncovered"><td class="line_num">121</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<label class="keyword">case&nbsp;</label>self::V_NONEED:
</td></tr><tr class="line_uncovered"><td class="line_num">122</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;default:
</td></tr><tr class="line_uncovered"><td class="line_num">123</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$wheres&nbsp;.=&nbsp;'1=1';
</td></tr><tr class="line_uncovered"><td class="line_num">124</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;
</td></tr><tr class="line_unexcutable"><td class="line_num">125</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
</td></tr><tr class="line_unexcutable"><td class="line_num">126</td><td >
</td></tr><tr class="line_uncovered"><td class="line_num">127</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$wheres&nbsp;.=&nbsp;'&nbsp;AND&nbsp;';
</td></tr><tr class="line_unexcutable"><td class="line_num">128</td><td >
</td></tr><tr class="line_uncovered"><td class="line_num">129</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<label class="keyword">switch&nbsp;</label>($statusParams[self::K_ACTIVED])&nbsp;{
</td></tr><tr class="line_uncovered"><td class="line_num">130</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<label class="keyword">case&nbsp;</label>self::V_YES:
</td></tr><tr class="line_uncovered"><td class="line_num">131</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$wheres&nbsp;.=&nbsp;'uc.actived&nbsp;=&nbsp;1';
</td></tr><tr class="line_uncovered"><td class="line_num">132</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;
</td></tr><tr class="line_uncovered"><td class="line_num">133</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<label class="keyword">case&nbsp;</label>self::V_NO:
</td></tr><tr class="line_uncovered"><td class="line_num">134</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$wheres&nbsp;.=&nbsp;'uc.actived&nbsp;=&nbsp;0';
</td></tr><tr class="line_uncovered"><td class="line_num">135</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;
</td></tr><tr class="line_uncovered"><td class="line_num">136</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<label class="keyword">case&nbsp;</label>self::V_NONEED:
</td></tr><tr class="line_uncovered"><td class="line_num">137</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;default:
</td></tr><tr class="line_uncovered"><td class="line_num">138</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$wheres&nbsp;.=&nbsp;'1=1';
</td></tr><tr class="line_uncovered"><td class="line_num">139</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;
</td></tr><tr class="line_unexcutable"><td class="line_num">140</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
</td></tr><tr class="line_unexcutable"><td class="line_num">141</td><td >
</td></tr><tr class="line_uncovered"><td class="line_num">142</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$wheres&nbsp;.=&nbsp;'&nbsp;AND&nbsp;';
</td></tr><tr class="line_unexcutable"><td class="line_num">143</td><td >
</td></tr><tr class="line_uncovered"><td class="line_num">144</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$now&nbsp;=&nbsp;date("Y-m-d&nbsp;H:i:s");
</td></tr><tr class="line_uncovered"><td class="line_num">145</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<label class="keyword">switch&nbsp;</label>($statusParams[self::K_STARTED])&nbsp;{
</td></tr><tr class="line_uncovered"><td class="line_num">146</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<label class="keyword">case&nbsp;</label>self::V_YES:
</td></tr><tr class="line_unexcutable"><td class="line_num">147</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$wheres&nbsp;.=&nbsp;"cp.started_at&nbsp;<='"&nbsp;.&nbsp;$now&nbsp;.&nbsp;"'";&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;已开始
</td></tr><tr class="line_uncovered"><td class="line_num">148</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;
</td></tr><tr class="line_uncovered"><td class="line_num">149</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<label class="keyword">case&nbsp;</label>self::V_NO:
</td></tr><tr class="line_unexcutable"><td class="line_num">150</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$wheres&nbsp;.=&nbsp;"cp.started_at&nbsp;>'"&nbsp;.&nbsp;$now&nbsp;.&nbsp;"'";&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;未开始
</td></tr><tr class="line_uncovered"><td class="line_num">151</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;
</td></tr><tr class="line_uncovered"><td class="line_num">152</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<label class="keyword">case&nbsp;</label>self::V_NONEED:
</td></tr><tr class="line_uncovered"><td class="line_num">153</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;default:
</td></tr><tr class="line_uncovered"><td class="line_num">154</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$wheres&nbsp;.=&nbsp;'1=1';
</td></tr><tr class="line_uncovered"><td class="line_num">155</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;
</td></tr><tr class="line_unexcutable"><td class="line_num">156</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
</td></tr><tr class="line_unexcutable"><td class="line_num">157</td><td >
</td></tr><tr class="line_uncovered"><td class="line_num">158</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$wheres&nbsp;.=&nbsp;'&nbsp;AND&nbsp;';
</td></tr><tr class="line_unexcutable"><td class="line_num">159</td><td >
</td></tr><tr class="line_covered"><td class="line_num">160</td><td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<label class="keyword">switch&nbsp;</label>($statusParams[self::K_FINISHED])&nbsp;{
</td></tr><tr class="line_uncovered"><td class="line_num">161</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<label class="keyword">case&nbsp;</label>self::V_YES:
</td></tr><tr class="line_unexcutable"><td class="line_num">162</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$wheres&nbsp;.=&nbsp;"cp.finished_at&nbsp;<='"&nbsp;.&nbsp;$now&nbsp;.&nbsp;"'";&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;已结束
</td></tr><tr class="line_uncovered"><td class="line_num">163</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;
</td></tr><tr class="line_uncovered"><td class="line_num">164</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<label class="keyword">case&nbsp;</label>self::V_NO:
</td></tr><tr class="line_unexcutable"><td class="line_num">165</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$wheres&nbsp;.=&nbsp;"cp.finished_at&nbsp;>'"&nbsp;.&nbsp;$now&nbsp;.&nbsp;"'";&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;未结束
</td></tr><tr class="line_covered"><td class="line_num">166</td><td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;
</td></tr><tr class="line_uncovered"><td class="line_num">167</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<label class="keyword">case&nbsp;</label>self::V_NONEED:
</td></tr><tr class="line_uncovered"><td class="line_num">168</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;default:
</td></tr><tr class="line_uncovered"><td class="line_num">169</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$wheres&nbsp;.=&nbsp;'1=1';
</td></tr><tr class="line_uncovered"><td class="line_num">170</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;
</td></tr><tr class="line_unexcutable"><td class="line_num">171</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
</td></tr><tr class="line_unexcutable"><td class="line_num">172</td><td >
</td></tr><tr class="line_uncovered"><td class="line_num">173</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<label class="keyword">return&nbsp;</label>$wheres;
</td></tr><tr class="line_unexcutable"><td class="line_num">174</td><td >&nbsp;&nbsp;&nbsp;&nbsp;}
</td></tr><tr class="line_unexcutable"><td class="line_num">175</td><td >
</td></tr><tr class="line_uncovered"><td class="line_num">176</td><td >&nbsp;&nbsp;&nbsp;&nbsp;<label class="keyword">private&nbsp;</label><label class="keyword">function&nbsp;</label>queryBySql($sql,&nbsp;$cacheKey,&nbsp;$hashKey&nbsp;=&nbsp;'')
</td></tr><tr class="line_unexcutable"><td class="line_num">177</td><td >&nbsp;&nbsp;&nbsp;&nbsp;{
</td></tr><tr class="line_uncovered"><td class="line_num">178</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$records&nbsp;=&nbsp;$this->getReadConnection()->query($sql);
</td></tr><tr class="line_uncovered"><td class="line_num">179</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$resultSet&nbsp;=&nbsp;<label class="keyword">new&nbsp;</label>Resultset(NULL,&nbsp;$this,&nbsp;$records);
</td></tr><tr class="line_unexcutable"><td class="line_num">180</td><td >
</td></tr><tr class="line_uncovered"><td class="line_num">181</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$userCoupons&nbsp;=&nbsp;[];
</td></tr><tr class="line_uncovered"><td class="line_num">182</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<label class="keyword">foreach&nbsp;</label>($resultSet&nbsp;<label class="keyword">as&nbsp;</label>$row)&nbsp;{
</td></tr><tr class="line_uncovered"><td class="line_num">183</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$hashField&nbsp;=&nbsp;$row->user_coupon_id;
</td></tr><tr class="line_uncovered"><td class="line_num">184</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$userCoupons[$hashField]&nbsp;=&nbsp;[
</td></tr><tr class="line_uncovered"><td class="line_num">185</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'user_id'&nbsp;=>&nbsp;$row->user_id,
</td></tr><tr class="line_uncovered"><td class="line_num">186</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'user_coupon_id'&nbsp;=>&nbsp;$row->user_coupon_id,
</td></tr><tr class="line_uncovered"><td class="line_num">187</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'coupon_id'&nbsp;=>&nbsp;$row->coupon_id,
</td></tr><tr class="line_uncovered"><td class="line_num">188</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'actived'&nbsp;=>&nbsp;$row->actived,
</td></tr><tr class="line_uncovered"><td class="line_num">189</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'used'&nbsp;=>&nbsp;$row->used,
</td></tr><tr class="line_uncovered"><td class="line_num">190</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'created_at'&nbsp;=>&nbsp;$row->created_at
</td></tr><tr class="line_uncovered"><td class="line_num">191</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;];
</td></tr><tr class="line_unexcutable"><td class="line_num">192</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
</td></tr><tr class="line_unexcutable"><td class="line_num">193</td><td >
</td></tr><tr class="line_uncovered"><td class="line_num">194</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<label class="keyword">if&nbsp;</label>(empty($userCoupons))&nbsp;{
</td></tr><tr class="line_uncovered"><td class="line_num">195</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Di::getDefault()->get(self::CACHE_CONNECTION)->hashMultiSet($cacheKey,&nbsp;['empty'&nbsp;=>&nbsp;1]);
</td></tr><tr class="line_uncovered"><td class="line_num">196</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;<label class="keyword">else&nbsp;</label>{
</td></tr><tr class="line_uncovered"><td class="line_num">197</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<label class="keyword">if&nbsp;</label>(empty($hashKey))&nbsp;{
</td></tr><tr class="line_uncovered"><td class="line_num">198</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Di::getDefault()->get(self::CACHE_CONNECTION)->hashMultiSet($cacheKey,&nbsp;$userCoupons);
</td></tr><tr class="line_uncovered"><td class="line_num">199</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;<label class="keyword">else&nbsp;</label>{
</td></tr><tr class="line_uncovered"><td class="line_num">200</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Di::getDefault()->get(self::CACHE_CONNECTION)->hashSet($cacheKey,&nbsp;$hashKey,&nbsp;$userCoupons);
</td></tr><tr class="line_unexcutable"><td class="line_num">201</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
</td></tr><tr class="line_unexcutable"><td class="line_num">202</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
</td></tr><tr class="line_uncovered"><td class="line_num">203</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Di::getDefault()->get(self::CACHE_CONNECTION)->expire($cacheKey,&nbsp;\Cache\MyRedis::TODAY_TTL);
</td></tr><tr class="line_unexcutable"><td class="line_num">204</td><td >
</td></tr><tr class="line_uncovered"><td class="line_num">205</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<label class="keyword">return&nbsp;</label>$userCoupons;
</td></tr><tr class="line_unexcutable"><td class="line_num">206</td><td >&nbsp;&nbsp;&nbsp;&nbsp;}
</td></tr><tr class="line_unexcutable"><td class="line_num">207</td><td >
</td></tr><tr class="line_uncovered"><td class="line_num">208</td><td >&nbsp;&nbsp;&nbsp;&nbsp;<label class="keyword">private&nbsp;</label><label class="keyword">function&nbsp;</label>genStatusCacheInOrder($statusParams)
</td></tr><tr class="line_unexcutable"><td class="line_num">209</td><td >&nbsp;&nbsp;&nbsp;&nbsp;{
</td></tr><tr class="line_uncovered"><td class="line_num">210</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$str&nbsp;=&nbsp;'';
</td></tr><tr class="line_uncovered"><td class="line_num">211</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$params&nbsp;=&nbsp;$statusParams;
</td></tr><tr class="line_unexcutable"><td class="line_num">212</td><td >
</td></tr><tr class="line_uncovered"><td class="line_num">213</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$params[self::K_ACTIVED]&nbsp;=&nbsp;array_key_exists(self::K_ACTIVED,&nbsp;$params)&nbsp;?&nbsp;$params[self::K_ACTIVED]&nbsp;:&nbsp;self::V_NONEED;
</td></tr><tr class="line_uncovered"><td class="line_num">214</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$params[self::K_USED]&nbsp;=&nbsp;array_key_exists(self::K_USED,&nbsp;$params)&nbsp;?&nbsp;$params[self::K_USED]&nbsp;:&nbsp;self::V_NONEED;
</td></tr><tr class="line_uncovered"><td class="line_num">215</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$params[self::K_STARTED]&nbsp;=&nbsp;array_key_exists(self::K_STARTED,&nbsp;$params)&nbsp;?&nbsp;$params[self::K_STARTED]&nbsp;:&nbsp;self::V_NONEED;
</td></tr><tr class="line_uncovered"><td class="line_num">216</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$params[self::K_FINISHED]&nbsp;=&nbsp;array_key_exists(self::K_FINISHED,&nbsp;$params)&nbsp;?&nbsp;$params[self::K_FINISHED]&nbsp;:&nbsp;self::V_NONEED;
</td></tr><tr class="line_unexcutable"><td class="line_num">217</td><td >
</td></tr><tr class="line_uncovered"><td class="line_num">218</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$str&nbsp;.=&nbsp;$params[self::K_ACTIVED]&nbsp;.&nbsp;$params[self::K_USED]&nbsp;.&nbsp;$params[self::K_STARTED]&nbsp;.&nbsp;$params[self::K_FINISHED];
</td></tr><tr class="line_uncovered"><td class="line_num">219</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<label class="keyword">return&nbsp;</label>$str;
</td></tr><tr class="line_unexcutable"><td class="line_num">220</td><td >&nbsp;&nbsp;&nbsp;&nbsp;}
</td></tr><tr class="line_unexcutable"><td class="line_num">221</td><td >
</td></tr><tr class="line_unexcutable"><td class="line_num">222</td><td >
</td></tr><tr class="line_uncovered"><td class="line_num">223</td><td >&nbsp;&nbsp;&nbsp;&nbsp;<label class="keyword">public&nbsp;</label><label class="keyword">function&nbsp;</label>getCouponOfScenario($userId,&nbsp;$scenarioCode,&nbsp;$scenarioValue)
</td></tr><tr class="line_unexcutable"><td class="line_num">224</td><td >&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;&nbsp;&nbsp;
</td></tr><tr class="line_uncovered"><td class="line_num">225</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(intval($userId)<1&nbsp;||&nbsp;!$scenarioCode){
</td></tr><tr class="line_uncovered"><td class="line_num">226</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<label class="keyword">return&nbsp;</label>[];
</td></tr><tr class="line_unexcutable"><td class="line_num">227</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
</td></tr><tr class="line_unexcutable"><td class="line_num">228</td><td >
</td></tr><tr class="line_uncovered"><td class="line_num">229</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$hashKey&nbsp;=&nbsp;$scenarioCode&nbsp;.&nbsp;':'&nbsp;.&nbsp;$scenarioValue;
</td></tr><tr class="line_uncovered"><td class="line_num">230</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$cacheKey&nbsp;=&nbsp;sprintf(self::CACHE_KEY_USER_COUPON_BY_SCENARIO_VALUE,&nbsp;$userId);
</td></tr><tr class="line_uncovered"><td class="line_num">231</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$userCoupons&nbsp;=&nbsp;Di::getDefault()->get(self::CACHE_CONNECTION)->hashGet($cacheKey,&nbsp;$hashKey,&nbsp;TRUE);
</td></tr><tr class="line_unexcutable"><td class="line_num">232</td><td >
</td></tr><tr class="line_uncovered"><td class="line_num">233</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<label class="keyword">if&nbsp;</label>(isset($userCoupons['empty']))&nbsp;{
</td></tr><tr class="line_uncovered"><td class="line_num">234</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<label class="keyword">return&nbsp;</label>[];
</td></tr><tr class="line_unexcutable"><td class="line_num">235</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
</td></tr><tr class="line_unexcutable"><td class="line_num">236</td><td >
</td></tr><tr class="line_uncovered"><td class="line_num">237</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<label class="keyword">if&nbsp;</label>(!$userCoupons)&nbsp;{
</td></tr><tr class="line_uncovered"><td class="line_num">238</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$sql&nbsp;=&nbsp;self::$sql_template&nbsp;.&nbsp;"&nbsp;WHERE&nbsp;uc.user_id&nbsp;=&nbsp;{$userId}&nbsp;AND&nbsp;uc.scenario_code&nbsp;='{$scenarioCode}'&nbsp;AND&nbsp;uc.scenario_value&nbsp;='{$scenarioValue}'";
</td></tr><tr class="line_unexcutable"><td class="line_num">239</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;排序
</td></tr><tr class="line_uncovered"><td class="line_num">240</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$sql&nbsp;.=&nbsp;'&nbsp;order&nbsp;by&nbsp;uc.id&nbsp;desc';
</td></tr><tr class="line_unexcutable"><td class="line_num">241</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$userCoupons&nbsp;=&nbsp;$this->queryBySql($sql,&nbsp;$cacheKey,&nbsp;$hashKey);&nbsp;&nbsp;//&nbsp;会设置缓存
</td></tr><tr class="line_unexcutable"><td class="line_num">242</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;
</td></tr><tr class="line_unexcutable"><td class="line_num">243</td><td >
</td></tr><tr class="line_uncovered"><td class="line_num">244</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<label class="keyword">return&nbsp;</label>$this->verifyUserCouponsByCache($userCoupons);
</td></tr><tr class="line_unexcutable"><td class="line_num">245</td><td >&nbsp;&nbsp;&nbsp;&nbsp;}
</td></tr><tr class="line_unexcutable"><td class="line_num">246</td><td >
</td></tr><tr class="line_uncovered"><td class="line_num">247</td><td >&nbsp;&nbsp;&nbsp;&nbsp;<label class="keyword">protected&nbsp;</label><label class="keyword">function&nbsp;</label>verifyUserCouponsByCache($userCoupons){
</td></tr><tr class="line_uncovered"><td class="line_num">248</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$verifiedUserCoupons&nbsp;=&nbsp;[];
</td></tr><tr class="line_uncovered"><td class="line_num">249</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<label class="keyword">foreach&nbsp;</label>($userCoupons&nbsp;<label class="keyword">as&nbsp;</label>$userCouponId&nbsp;=>&nbsp;$userCoupon)&nbsp;{
</td></tr><tr class="line_uncovered"><td class="line_num">250</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$couponId&nbsp;=&nbsp;$userCoupon['coupon_id'];
</td></tr><tr class="line_uncovered"><td class="line_num">251</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$couponCacheKey&nbsp;=&nbsp;CouponModel::CACHE_KEY_COUPONS_ONLINE;
</td></tr><tr class="line_uncovered"><td class="line_num">252</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$coupon&nbsp;=&nbsp;Di::getDefault()->get(self::CACHE_CONNECTION)->hashGet($couponCacheKey,$couponId,TRUE);
</td></tr><tr class="line_unexcutable"><td class="line_num">253</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(empty($coupon)){&nbsp;//&nbsp;当前优惠券并不存在于缓存中（比如被清缓存）,则去数据库中找最新的
</td></tr><tr class="line_uncovered"><td class="line_num">254</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$coupon&nbsp;=&nbsp;CouponModel::queryOnlineCouponById($couponId);
</td></tr><tr class="line_uncovered"><td class="line_num">255</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(empty($coupon)){
</td></tr><tr class="line_unexcutable"><td class="line_num">256</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;仍然为空，说明优惠券已下线（online=0），那么这一条优惠券就不返回
</td></tr><tr class="line_uncovered"><td class="line_num">257</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;continue;
</td></tr><tr class="line_unexcutable"><td class="line_num">258</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
</td></tr><tr class="line_uncovered"><td class="line_num">259</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Di::getDefault()->get(self::CACHE_CONNECTION)->hashSet($couponCacheKey,&nbsp;$couponId,$coupon);
</td></tr><tr class="line_unexcutable"><td class="line_num">260</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
</td></tr><tr class="line_unexcutable"><td class="line_num">261</td><td >
</td></tr><tr class="line_unexcutable"><td class="line_num">262</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;针对&nbsp;绝对有效期/相对有效期&nbsp;的优惠券,&nbsp;设置其到期时间:&nbsp;left_time
</td></tr><tr class="line_uncovered"><td class="line_num">263</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<label class="keyword">if&nbsp;</label>(empty($coupon['ttl']))&nbsp;{
</td></tr><tr class="line_unexcutable"><td class="line_num">264</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;ttl为空，优惠券到期时间为绝对时间
</td></tr><tr class="line_uncovered"><td class="line_num">265</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$userCoupon['left_time']&nbsp;=&nbsp;strtotime($coupon['finished_at']);
</td></tr><tr class="line_uncovered"><td class="line_num">266</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;<label class="keyword">else&nbsp;</label>{
</td></tr><tr class="line_unexcutable"><td class="line_num">267</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;ttl不为空，按相对时间算（领取日期+生命周期）
</td></tr><tr class="line_uncovered"><td class="line_num">268</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$userCoupon['left_time']&nbsp;=&nbsp;strtotime($userCoupon['created_at'])&nbsp;+&nbsp;intval($coupon['ttl']);
</td></tr><tr class="line_unexcutable"><td class="line_num">269</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
</td></tr><tr class="line_unexcutable"><td class="line_num">270</td><td >
</td></tr><tr class="line_unexcutable"><td class="line_num">271</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;合并数据用于返回
</td></tr><tr class="line_uncovered"><td class="line_num">272</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$verifiedUserCoupons[$userCouponId]&nbsp;=&nbsp;[
</td></tr><tr class="line_uncovered"><td class="line_num">273</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'user_id'&nbsp;=>&nbsp;$userCoupon['user_id'],
</td></tr><tr class="line_uncovered"><td class="line_num">274</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'user_coupon_id'&nbsp;=>&nbsp;$userCoupon['user_coupon_id'],
</td></tr><tr class="line_uncovered"><td class="line_num">275</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'coupon_id'&nbsp;=>&nbsp;$userCoupon['coupon_id'],
</td></tr><tr class="line_uncovered"><td class="line_num">276</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'actived'&nbsp;=>&nbsp;$userCoupon['actived'],
</td></tr><tr class="line_uncovered"><td class="line_num">277</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'used'&nbsp;=>&nbsp;$userCoupon['used'],
</td></tr><tr class="line_uncovered"><td class="line_num">278</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'created_at'&nbsp;=>&nbsp;$userCoupon['created_at'],
</td></tr><tr class="line_uncovered"><td class="line_num">279</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'name'&nbsp;=>&nbsp;$coupon['name'],
</td></tr><tr class="line_uncovered"><td class="line_num">280</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'description'&nbsp;=>&nbsp;$coupon['description'],
</td></tr><tr class="line_uncovered"><td class="line_num">281</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'cover'&nbsp;=>&nbsp;$coupon['cover'],
</td></tr><tr class="line_uncovered"><td class="line_num">282</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'amount'&nbsp;=>&nbsp;$coupon['amount'],
</td></tr><tr class="line_uncovered"><td class="line_num">283</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'is_discount'&nbsp;=>&nbsp;$coupon['is_discount'],
</td></tr><tr class="line_uncovered"><td class="line_num">284</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'started_at'&nbsp;=>&nbsp;$coupon['started_at'],
</td></tr><tr class="line_uncovered"><td class="line_num">285</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'finished_at'&nbsp;=>&nbsp;$coupon['finished_at'],
</td></tr><tr class="line_uncovered"><td class="line_num">286</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'left_time'&nbsp;=>&nbsp;$userCoupon['left_time']
</td></tr><tr class="line_uncovered"><td class="line_num">287</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;];
</td></tr><tr class="line_unexcutable"><td class="line_num">288</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
</td></tr><tr class="line_uncovered"><td class="line_num">289</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<label class="keyword">return&nbsp;</label>$verifiedUserCoupons;
</td></tr><tr class="line_unexcutable"><td class="line_num">290</td><td >&nbsp;&nbsp;&nbsp;&nbsp;}
</td></tr><tr class="line_unexcutable"><td class="line_num">291</td><td >
</td></tr><tr class="line_uncovered"><td class="line_num">292</td><td >&nbsp;&nbsp;&nbsp;&nbsp;<label class="keyword">public&nbsp;</label><label class="keyword">function&nbsp;</label>getCouponOfScenarioByUid($userId,&nbsp;$scenarioCode)
</td></tr><tr class="line_unexcutable"><td class="line_num">293</td><td >&nbsp;&nbsp;&nbsp;&nbsp;{
</td></tr><tr class="line_unexcutable"><td class="line_num">294</td><td >
</td></tr><tr class="line_uncovered"><td class="line_num">295</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(intval($userId)<1&nbsp;||&nbsp;!$scenarioCode){
</td></tr><tr class="line_uncovered"><td class="line_num">296</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<label class="keyword">return&nbsp;</label>[];
</td></tr><tr class="line_unexcutable"><td class="line_num">297</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
</td></tr><tr class="line_unexcutable"><td class="line_num">298</td><td >
</td></tr><tr class="line_uncovered"><td class="line_num">299</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$cacheKey&nbsp;=&nbsp;sprintf(self::CACHE_KEY_USER_COUPON_BY_SCENARIO_UID,&nbsp;$userId);
</td></tr><tr class="line_uncovered"><td class="line_num">300</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$userCoupons&nbsp;=&nbsp;Di::getDefault()->get(self::CACHE_CONNECTION)->hashGet($cacheKey,&nbsp;$scenarioCode,&nbsp;TRUE);
</td></tr><tr class="line_uncovered"><td class="line_num">301</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<label class="keyword">if&nbsp;</label>(isset($userCoupons['empty']))&nbsp;{
</td></tr><tr class="line_uncovered"><td class="line_num">302</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<label class="keyword">return&nbsp;</label>[];
</td></tr><tr class="line_unexcutable"><td class="line_num">303</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
</td></tr><tr class="line_unexcutable"><td class="line_num">304</td><td >
</td></tr><tr class="line_uncovered"><td class="line_num">305</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<label class="keyword">if&nbsp;</label>(!$userCoupons)&nbsp;{
</td></tr><tr class="line_uncovered"><td class="line_num">306</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$sql&nbsp;=&nbsp;self::$sql_template&nbsp;.&nbsp;"&nbsp;WHERE&nbsp;uc.user_id&nbsp;=&nbsp;{$userId}&nbsp;AND&nbsp;uc.scenario_code&nbsp;='{$scenarioCode}'";
</td></tr><tr class="line_uncovered"><td class="line_num">307</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$sql&nbsp;.=&nbsp;'&nbsp;order&nbsp;by&nbsp;uc.id&nbsp;desc';
</td></tr><tr class="line_unexcutable"><td class="line_num">308</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$userCoupons&nbsp;=&nbsp;$this->queryBySql($sql,&nbsp;$cacheKey);&nbsp;&nbsp;//&nbsp;会设置缓存
</td></tr><tr class="line_unexcutable"><td class="line_num">309</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;
</td></tr><tr class="line_unexcutable"><td class="line_num">310</td><td >
</td></tr><tr class="line_uncovered"><td class="line_num">311</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<label class="keyword">return&nbsp;</label>$this->verifyUserCouponsByCache($userCoupons);
</td></tr><tr class="line_unexcutable"><td class="line_num">312</td><td >&nbsp;&nbsp;&nbsp;&nbsp;}
</td></tr><tr class="line_unexcutable"><td class="line_num">313</td><td >
</td></tr><tr class="line_uncovered"><td class="line_num">314</td><td >&nbsp;&nbsp;&nbsp;&nbsp;<label class="keyword">public&nbsp;</label><label class="keyword">function&nbsp;</label>getCouponDetailByOrderId($userId,&nbsp;$orderId)
</td></tr><tr class="line_unexcutable"><td class="line_num">315</td><td >&nbsp;&nbsp;&nbsp;&nbsp;{
</td></tr><tr class="line_uncovered"><td class="line_num">316</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(intval($userId)<1){
</td></tr><tr class="line_uncovered"><td class="line_num">317</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<label class="keyword">return&nbsp;</label>[];
</td></tr><tr class="line_unexcutable"><td class="line_num">318</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
</td></tr><tr class="line_unexcutable"><td class="line_num">319</td><td >
</td></tr><tr class="line_uncovered"><td class="line_num">320</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$cacheKey&nbsp;=&nbsp;sprintf(self::CACHE_KEY_USER_COUPON_BY_ORDERID,&nbsp;$userId);
</td></tr><tr class="line_uncovered"><td class="line_num">321</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$userCoupons&nbsp;=&nbsp;Di::getDefault()->get(self::CACHE_CONNECTION)->hashGet($cacheKey,&nbsp;$orderId,&nbsp;TRUE);
</td></tr><tr class="line_unexcutable"><td class="line_num">322</td><td >
</td></tr><tr class="line_uncovered"><td class="line_num">323</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<label class="keyword">if&nbsp;</label>(!$userCoupons)&nbsp;{
</td></tr><tr class="line_uncovered"><td class="line_num">324</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$sql&nbsp;=&nbsp;self::$sql_template&nbsp;.&nbsp;"&nbsp;WHERE&nbsp;uc.user_id&nbsp;=&nbsp;{$userId}&nbsp;AND&nbsp;uc.order_id&nbsp;='{$orderId}'";
</td></tr><tr class="line_unexcutable"><td class="line_num">325</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$userCoupons&nbsp;=&nbsp;$this->queryBySql($sql,&nbsp;$cacheKey,&nbsp;$orderId);&nbsp;&nbsp;//&nbsp;会设置缓存
</td></tr><tr class="line_unexcutable"><td class="line_num">326</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
</td></tr><tr class="line_unexcutable"><td class="line_num">327</td><td >
</td></tr><tr class="line_uncovered"><td class="line_num">328</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<label class="keyword">return&nbsp;</label>$this->verifyUserCouponsByCache($userCoupons);
</td></tr><tr class="line_unexcutable"><td class="line_num">329</td><td >&nbsp;&nbsp;&nbsp;&nbsp;}
</td></tr><tr class="line_unexcutable"><td class="line_num">330</td><td >
</td></tr><tr class="line_uncovered"><td class="line_num">331</td><td >&nbsp;&nbsp;&nbsp;&nbsp;<label class="keyword">public&nbsp;</label><label class="keyword">function&nbsp;</label>getUserCouponsByStatus($userId,&nbsp;$statusParams&nbsp;=&nbsp;NULL)
</td></tr><tr class="line_unexcutable"><td class="line_num">332</td><td >&nbsp;&nbsp;&nbsp;&nbsp;{
</td></tr><tr class="line_uncovered"><td class="line_num">333</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(intval($userId)<1&nbsp;||&nbsp;NULL&nbsp;==&nbsp;$statusParams){
</td></tr><tr class="line_uncovered"><td class="line_num">334</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<label class="keyword">return&nbsp;</label>[];
</td></tr><tr class="line_unexcutable"><td class="line_num">335</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
</td></tr><tr class="line_unexcutable"><td class="line_num">336</td><td >
</td></tr><tr class="line_uncovered"><td class="line_num">337</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$cacheKey&nbsp;=&nbsp;sprintf(self::CACHE_KEY_USER_COUPONS,&nbsp;$userId,&nbsp;$this->genStatusCacheInOrder($statusParams));
</td></tr><tr class="line_uncovered"><td class="line_num">338</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$userCoupons&nbsp;=&nbsp;Di::getDefault()->get(self::CACHE_CONNECTION)->hashGetAll($cacheKey);
</td></tr><tr class="line_uncovered"><td class="line_num">339</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<label class="keyword">if&nbsp;</label>(isset($userCoupons['empty']))&nbsp;{
</td></tr><tr class="line_uncovered"><td class="line_num">340</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<label class="keyword">return&nbsp;</label>[];
</td></tr><tr class="line_unexcutable"><td class="line_num">341</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
</td></tr><tr class="line_unexcutable"><td class="line_num">342</td><td >
</td></tr><tr class="line_uncovered"><td class="line_num">343</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<label class="keyword">if&nbsp;</label>(!$userCoupons)&nbsp;{
</td></tr><tr class="line_uncovered"><td class="line_num">344</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$wheres&nbsp;=&nbsp;$this->buildWheres($statusParams)&nbsp;.&nbsp;"&nbsp;AND&nbsp;cp.online=1&nbsp;AND&nbsp;uc.user_id={$userId}";
</td></tr><tr class="line_uncovered"><td class="line_num">345</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$sql&nbsp;=&nbsp;self::$sql_template&nbsp;.&nbsp;"&nbsp;WHERE&nbsp;{$wheres}";
</td></tr><tr class="line_unexcutable"><td class="line_num">346</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$userCoupons&nbsp;=&nbsp;$this->queryBySql($sql,&nbsp;$cacheKey);&nbsp;&nbsp;//&nbsp;会设置缓存
</td></tr><tr class="line_unexcutable"><td class="line_num">347</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;
</td></tr><tr class="line_unexcutable"><td class="line_num">348</td><td >
</td></tr><tr class="line_uncovered"><td class="line_num">349</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<label class="keyword">return&nbsp;</label>$this->verifyUserCouponsByCache($userCoupons);
</td></tr><tr class="line_unexcutable"><td class="line_num">350</td><td >&nbsp;&nbsp;&nbsp;&nbsp;}
</td></tr><tr class="line_unexcutable"><td class="line_num">351</td><td >
</td></tr><tr class="line_uncovered"><td class="line_num">352</td><td >&nbsp;&nbsp;&nbsp;&nbsp;<label class="keyword">public&nbsp;</label><label class="keyword">function&nbsp;</label>sendCoupons($userId,&nbsp;$couponList,&nbsp;$scenarioCode,&nbsp;$scenarioValue)
</td></tr><tr class="line_unexcutable"><td class="line_num">353</td><td >&nbsp;&nbsp;&nbsp;&nbsp;{
</td></tr><tr class="line_uncovered"><td class="line_num">354</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$success&nbsp;=&nbsp;TRUE;
</td></tr><tr class="line_unexcutable"><td class="line_num">355</td><td >
</td></tr><tr class="line_uncovered"><td class="line_num">356</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<label class="keyword">if&nbsp;</label>(empty($couponList)&nbsp;||&nbsp;empty($scenarioCode))&nbsp;{
</td></tr><tr class="line_uncovered"><td class="line_num">357</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<label class="keyword">return&nbsp;</label>FALSE;
</td></tr><tr class="line_unexcutable"><td class="line_num">358</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
</td></tr><tr class="line_unexcutable"><td class="line_num">359</td><td >
</td></tr><tr class="line_uncovered"><td class="line_num">360</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<label class="keyword">if&nbsp;</label>(intval($userId)&nbsp;<=&nbsp;0)&nbsp;{
</td></tr><tr class="line_uncovered"><td class="line_num">361</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<label class="keyword">return&nbsp;</label>FALSE;
</td></tr><tr class="line_unexcutable"><td class="line_num">362</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
</td></tr><tr class="line_unexcutable"><td class="line_num">363</td><td >
</td></tr><tr class="line_uncovered"><td class="line_num">364</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<label class="keyword">if&nbsp;</label>(empty($scenarioValue))&nbsp;{
</td></tr><tr class="line_uncovered"><td class="line_num">365</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$scenarioValue&nbsp;=&nbsp;'-';
</td></tr><tr class="line_unexcutable"><td class="line_num">366</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
</td></tr><tr class="line_unexcutable"><td class="line_num">367</td><td >
</td></tr><tr class="line_unexcutable"><td class="line_num">368</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$active&nbsp;=&nbsp;1;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;默认自动激活！
</td></tr><tr class="line_uncovered"><td class="line_num">369</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$scenario&nbsp;=&nbsp;ScenarioModel::getDetail($scenarioCode);
</td></tr><tr class="line_uncovered"><td class="line_num">370</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<label class="keyword">if&nbsp;</label>(!empty($scenario)&nbsp;&&&nbsp;isset($scenario['active']))&nbsp;{
</td></tr><tr class="line_unexcutable"><td class="line_num">371</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$active&nbsp;=&nbsp;intval($scenario['active']);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;是否自动激活
</td></tr><tr class="line_unexcutable"><td class="line_num">372</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
</td></tr><tr class="line_unexcutable"><td class="line_num">373</td><td >
</td></tr><tr class="line_uncovered"><td class="line_num">374</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<label class="keyword">foreach&nbsp;</label>($couponList&nbsp;<label class="keyword">as&nbsp;</label>$key&nbsp;=>&nbsp;$couponId)&nbsp;{
</td></tr><tr class="line_uncovered"><td class="line_num">375</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this->getWriteConnection()->begin();
</td></tr><tr class="line_uncovered"><td class="line_num">376</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<label class="keyword">try&nbsp;</label>{
</td></tr><tr class="line_uncovered"><td class="line_num">377</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$newUserCoupon&nbsp;=&nbsp;<label class="keyword">new&nbsp;</label>UserCouponModel();
</td></tr><tr class="line_uncovered"><td class="line_num">378</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$newUserCoupon->user_id&nbsp;=&nbsp;intval($userId);
</td></tr><tr class="line_uncovered"><td class="line_num">379</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$newUserCoupon->coupon_id&nbsp;=&nbsp;intval($couponId);
</td></tr><tr class="line_uncovered"><td class="line_num">380</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$newUserCoupon->used&nbsp;=&nbsp;0;
</td></tr><tr class="line_uncovered"><td class="line_num">381</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$newUserCoupon->order_id&nbsp;=&nbsp;0;
</td></tr><tr class="line_uncovered"><td class="line_num">382</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$newUserCoupon->actived&nbsp;=&nbsp;$active;
</td></tr><tr class="line_uncovered"><td class="line_num">383</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$newUserCoupon->scenario_code&nbsp;=&nbsp;$scenarioCode;
</td></tr><tr class="line_uncovered"><td class="line_num">384</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$newUserCoupon->scenario_value&nbsp;=&nbsp;$scenarioValue;
</td></tr><tr class="line_unexcutable"><td class="line_num">385</td><td >
</td></tr><tr class="line_uncovered"><td class="line_num">386</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<label class="keyword">if&nbsp;</label>($newUserCoupon->save()&nbsp;==&nbsp;FALSE)&nbsp;{
</td></tr><tr class="line_unexcutable"><td class="line_num">387</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;插入失败
</td></tr><tr class="line_uncovered"><td class="line_num">388</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\Phalcon\DI::getDefault()->get('log')->error('insert&nbsp;user&nbsp;coupon&nbsp;failed\nUserId:'&nbsp;.&nbsp;$userId&nbsp;.&nbsp;'&nbsp;Coupons:'&nbsp;.&nbsp;json_encode($couponId));
</td></tr><tr class="line_uncovered"><td class="line_num">389</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$success&nbsp;=&nbsp;FALSE;
</td></tr><tr class="line_uncovered"><td class="line_num">390</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this->getWriteConnection()->rollback();
</td></tr><tr class="line_uncovered"><td class="line_num">391</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;
</td></tr><tr class="line_uncovered"><td class="line_num">392</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;<label class="keyword">else&nbsp;</label>{
</td></tr><tr class="line_unexcutable"><td class="line_num">393</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;插入成功，继续插入Notice
</td></tr><tr class="line_uncovered"><td class="line_num">394</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$newNotice&nbsp;=&nbsp;<label class="keyword">new&nbsp;</label>NoticeModel();
</td></tr><tr class="line_uncovered"><td class="line_num">395</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$newNotice->day&nbsp;=&nbsp;intval(date("Ymd"));
</td></tr><tr class="line_uncovered"><td class="line_num">396</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$newNotice->coupon_id&nbsnbsp;=&nbsp;intval($couponId);
</td></tr><tr class="line_uncovered"><td class="line_num">397</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$newNotice->user_id&nbsp;=&nbsp;intval($userId);
</td></tr><tr class="line_unexcutable"><td class="line_num">398</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//$newNotice->user_id&nbsp;=&nbsp;'TEXT';&nbsp;//&nbsp;造成插入失败&nbsp;&nbsp;<label class="keyword">f<label class="keyword">or&nbsp;</label></label>test
</td></tr><tr class="line_uncovered"><td class="line_num">399</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<label class="keyword">if&nbsp;</label>($newNotice->save()&nbsp;==&nbsp;FALSE)&nbsp;{
</td></tr><tr class="line_unexcutable"><td class="line_num">400</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;插入失败
</td></tr><tr class="line_uncovered"><td class="line_num">401</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\Phalcon\DI::getDefault()->get('log')->error('insert&nbsp;user&nbsp;coupon&nbsp;failed\nUserId:'&nbsp;.&nbsp;$userId&nbsp;.&nbsp;'&nbsp;Coupons:'&nbsp;.&nbsp;json_encode($couponId));
</td></tr><tr class="line_uncovered"><td class="line_num">402</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$success&nbsp;=&nbsp;FALSE;
</td></tr><tr class="line_uncovered"><td class="line_num">403</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this->getWriteConnection()->rollback();
</td></tr><tr class="line_uncovered"><td class="line_num">404</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;
</td></tr><tr class="line_unexcutable"><td class="line_num">405</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
</td></tr><tr class="line_unexcutable"><td class="line_num">406</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
</td></tr><tr class="line_unexcutable"><td class="line_num">407</td><td >
</td></tr><tr class="line_uncovered"><td class="line_num">408</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this->getWriteConnection()->commit();
</td></tr><tr class="line_uncovered"><td class="line_num">409</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;<label class="keyword">catch&nbsp;</label>(Exception&nbsp;$e)&nbsp;{
</td></tr><tr class="line_uncovered"><td class="line_num">410</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\Phalcon\DI::getDefault()->get('log')->error($e->getMessage());
</td></tr><tr class="line_uncovered"><td class="line_num">411</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this->getWriteConnection()->rollback();
</td></tr><tr class="line_uncovered"><td class="line_num">412</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<label class="keyword">return&nbsp;</label>FALSE;
</td></tr><tr class="line_unexcutable"><td class="line_num">413</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
</td></tr><tr class="line_unexcutable"><td class="line_num">414</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
</td></tr><tr class="line_uncovered"><td class="line_num">415</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<label class="keyword">return&nbsp;</label>$success;
</td></tr><tr class="line_unexcutable"><td class="line_num">416</td><td >&nbsp;&nbsp;&nbsp;&nbsp;}
</td></tr><tr class="line_unexcutable"><td class="line_num">417</td><td >
</td></tr><tr class="line_unexcutable"><td class="line_num">418</td><td >&nbsp;&nbsp;&nbsp;&nbsp;/**
</td></tr><tr class="line_unexcutable"><td class="line_num">419</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@desc&nbsp;更新优惠券
</td></tr><tr class="line_unexcutable"><td class="line_num">420</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;$userCouponId
</td></tr><tr class="line_unexcutable"><td class="line_num">421</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;$orderId
</td></tr><tr class="line_unexcutable"><td class="line_num">422</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@<label class="keyword">return&nbsp;</label>array
</td></tr><tr class="line_unexcutable"><td class="line_num">423</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/
</td></tr><tr class="line_uncovered"><td class="line_num">424</td><td >&nbsp;&nbsp;&nbsp;&nbsp;<label class="keyword">public&nbsp;</label><label class="keyword">static&nbsp;</label><label class="keyword">function&nbsp;</label>setCouponUsed($userCouponId,&nbsp;$orderId&nbsp;=&nbsp;0)
</td></tr><tr class="line_unexcutable"><td class="line_num">425</td><td >&nbsp;&nbsp;&nbsp;&nbsp;{
</td></tr><tr class="line_uncovered"><td class="line_num">426</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<label class="keyword">if&nbsp;</label>(intval($userCouponId))&nbsp;{
</td></tr><tr class="line_uncovered"><td class="line_num">427</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$record&nbsp;=&nbsp;[
</td></tr><tr class="line_uncovered"><td class="line_num">428</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'used'&nbsp;=>&nbsp;1,
</td></tr><tr class="line_uncovered"><td class="line_num">429</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'order_id'&nbsp;=>&nbsp;$orderId,
</td></tr><tr class="line_uncovered"><td class="line_num">430</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'updated_at'&nbsp;=>&nbsp;date('Y-m-d&nbsp;H:i:s'),
</td></tr><tr class="line_uncovered"><td class="line_num">431</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;];
</td></tr><tr class="line_unexcutable"><td class="line_num">432</td><td >
</td></tr><tr class="line_uncovered"><td class="line_num">433</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$where&nbsp;=&nbsp;[
</td></tr><tr class="line_uncovered"><td class="line_num">434</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'id'&nbsp;=>&nbsp;$userCouponId,
</td></tr><tr class="line_uncovered"><td class="line_num">435</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;];
</td></tr><tr class="line_uncovered"><td class="line_num">436</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<label class="keyword">return&nbsp;</label>self::updateRecord($record,&nbsp;$where);
</td></tr><tr class="line_unexcutable"><td class="line_num">437</td><td >
</td></tr><tr class="line_uncovered"><td class="line_num">438</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;<label class="keyword">else&nbsp;</label>{
</td></tr><tr class="line_uncovered"><td class="line_num">439</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<label class="keyword">return&nbsp;</label>FALSE;
</td></tr><tr class="line_unexcutable"><td class="line_num">440</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
</td></tr><tr class="line_unexcutable"><td class="line_num">441</td><td >&nbsp;&nbsp;&nbsp;&nbsp;}
</td></tr><tr class="line_unexcutable"><td class="line_num">442</td><td >
</td></tr><tr class="line_unexcutable"><td class="line_num">443</td><td >&nbsp;&nbsp;&nbsp;&nbsp;/**
</td></tr><tr class="line_unexcutable"><td class="line_num">444</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@desc&nbsp;根据用户ID&nbsp;和订单ID恢复优惠券
</td></tr><tr class="line_unexcutable"><td class="line_num">445</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;$userId
</td></tr><tr class="line_unexcutable"><td class="line_num">446</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;$orderId
</td></tr><tr class="line_unexcutable"><td class="line_num">447</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@<label class="keyword">return&nbsp;</label>bool
</td></tr><tr class="line_unexcutable"><td class="line_num">448</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/
</td></tr><tr class="line_uncovered"><td class="line_num">449</td><td >&nbsp;&nbsp;&nbsp;&nbsp;<label class="keyword">public&nbsp;</label><label class="keyword">static&nbsp;</label><label class="keyword">function&nbsp;</label>setCouponRestoredWithUserIdAndOrderId($userId,&nbsp;$orderId)
</td></tr><tr class="line_unexcutable"><td class="line_num">450</td><td >&nbsp;&nbsp;&nbsp;&nbsp;{
</td></tr><tr class="line_uncovered"><td class="line_num">451</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<label class="keyword">if&nbsp;</label>($userId&nbsp;&&&nbsp;$orderId)&nbsp;{
</td></tr><tr class="line_uncovered"><td class="line_num">452</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$record&nbsp;=&nbsp;[
</td></tr><tr class="line_uncovered"><td class="line_num">453</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'used'&nbsp;=>&nbsp;0,
</td></tr><tr class="line_uncovered"><td class="line_num">454</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'order_id'&nbsp;=>&nbsp;0,
</td></tr><tr class="line_uncovered"><td class="line_num">455</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'updated_at'&nbsp;=>&nbsp;date('Y-m-d&nbsp;H:i:s'),
</td></tr><tr class="line_uncovered"><td class="line_num">456</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;];
</td></tr><tr class="line_unexcutable"><td class="line_num">457</td><td >
</td></tr><tr class="line_uncovered"><td class="line_num">458</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$where&nbsp;=&nbsp;[
</td></tr><tr class="line_uncovered"><td class="line_num">459</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'user_id'&nbsp;=>&nbsp;$userId,
</td></tr><tr class="line_uncovered"><td class="line_num">460</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'order_id'&nbsp;=>&nbsp;$orderId,
</td></tr><tr class="line_uncovered"><td class="line_num">461</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;];
</td></tr><tr class="line_uncovered"><td class="line_num">462</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<label class="keyword">return&nbsp;</label>self::updateRecord($record,&nbsp;$where);
</td></tr><tr class="line_unexcutable"><td class="line_num">463</td><td >
</td></tr><tr class="line_uncovered"><td class="line_num">464</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;<label class="keyword">else&nbsp;</label>{
</td></tr><tr class="line_uncovered"><td class="line_num">465</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<label class="keyword">return&nbsp;</label>FALSE;
</td></tr><tr class="line_unexcutable"><td class="line_num">466</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
</td></tr><tr class="line_unexcutable"><td class="line_num">467</td><td >&nbsp;&nbsp;&nbsp;&nbsp;}
</td></tr><tr class="line_unexcutable"><td class="line_num">468</td><td >
</td></tr><tr class="line_unexcutable"><td class="line_num">469</td><td >&nbsp;&nbsp;&nbsp;&nbsp;/**
</td></tr><tr class="line_unexcutable"><td class="line_num">470</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@desc&nbsp;根据优惠券ID恢复优惠券
</td></tr><tr class="line_unexcutable"><td class="line_num">471</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;$userId
</td></tr><tr class="line_unexcutable"><td class="line_num">472</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;$userCouponId
</td></tr><tr class="line_unexcutable"><td class="line_num">473</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@<label class="keyword">return&nbsp;</label>bool
</td></tr><tr class="line_unexcutable"><td class="line_num">474</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/
</td></tr><tr class="line_uncovered"><td class="line_num">475</td><td >&nbsp;&nbsp;&nbsp;&nbsp;<label class="keyword">public&nbsp;</label><label class="keyword">static&nbsp;</label><label class="keyword">function&nbsp;</label>setCouponActived($userId,&nbsp;$userCouponId)
</td></tr><tr class="line_unexcutable"><td class="line_num">476</td><td >&nbsp;&nbsp;&nbsp;&nbsp;{
</td></tr><tr class="line_uncovered"><td class="line_num">477</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<label class="keyword">if&nbsp;</label>($userId&nbsp;&&&nbsp;$userCouponId)&nbsp;{
</td></tr><tr class="line_uncovered"><td class="line_num">478</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$record&nbsp;=&nbsp;[
</td></tr><tr class="line_uncovered"><td class="line_num">479</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'actived'&nbsp;=>&nbsp;1,
</td></tr><tr class="line_uncovered"><td class="line_num">480</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'updated_at'&nbsp;=>&nbsp;date('Y-m-d&nbsp;H:i:s'),
</td></tr><tr class="line_uncovered"><td class="line_num">481</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;];
</td></tr><tr class="line_unexcutable"><td class="line_num">482</td><td >
</td></tr><tr class="line_uncovered"><td class="line_num">483</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$where&nbsp;=&nbsp;[
</td></tr><tr class="line_uncovered"><td class="line_num">484</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'user_id'&nbsp;=>&nbsp;$userId,
</td></tr><tr class="line_uncovered"><td class="line_num">485</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'id'&nbsp;=>&nbsp;$userCouponId,
</td></tr><tr class="line_uncovered"><td class="line_num">486</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;];
</td></tr><tr class="line_uncovered"><td class="line_num">487</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<label class="keyword">return&nbsp;</label>self::updateRecord($record,&nbsp;$where);
</td></tr><tr class="line_unexcutable"><td class="line_num">488</td><td >
</td></tr><tr class="line_uncovered"><td class="line_num">489</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;<label class="keyword">else&nbsp;</label>{
</td></tr><tr class="line_uncovered"><td class="line_num">490</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<label class="keyword">return&nbsp;</label>FALSE;
</td></tr><tr class="line_unexcutable"><td class="line_num">491</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
</td></tr><tr class="line_unexcutable"><td class="line_num">492</td><td >&nbsp;&nbsp;&nbsp;&nbsp;}
</td></tr><tr class="line_unexcutable"><td class="line_num">493</td><td >}
</td></tr><tr class="line_unexcutable"><td class="line_num">494</td><td ></td></tr></table><table><tr class="line_uncovered"><td class="line_num">0</td><td ><?php
</td></tr><tr class="line_unexcutable"><td class="line_num">1</td><td >/**
</td></tr><tr class="line_unexcutable"><td class="line_num">2</td><td >&nbsp;*&nbsp;User&nbsp;:&nbsp;wujian
</td></tr><tr class="line_unexcutable"><td class="line_num">3</td><td >&nbsp;*&nbsp;Notice&nbsp;:&nbsp;用户优惠券查询
</td></tr><tr class="line_unexcutable"><td class="line_num">4</td><td >&nbsp;*/
</td></tr><tr class="line_uncovered"><td class="line_num">5</td><td ><label class="keyword">namespace&nbsp;</label>Models;
</td></tr><tr class="line_unexcutable"><td class="line_num">6</td><td >
</td></tr><tr class="line_uncovered"><td class="line_num">7</td><td ><label class="keyword">use&nbsp;</label>\Phalcon\Di;
</td></tr><tr class="line_uncovered"><td class="line_num">8</td><td ><label class="keyword">use&nbsp;</label>Phalcon\Mvc\Model\Resultset\Simple&nbsp;<label class="keyword">as&nbsp;</label>Resultset;
</td></tr><tr class="line_covered"><td class="line_num">9</td><td><label class="keyword">use&nbsp;</label>Models\NoticeModel;
</td></tr><tr class="line_uncovered"><td class="line_num">10</td><td ><label class="keyword">use&nbsp;</label>Models\ScenarioModel;
</td></tr><tr class="line_uncovered"><td class="line_num">11</td><td ><label class="keyword">use&nbsp;</label>Models\CouponModel;
</td></tr><tr class="line_unexcutable"><td class="line_num">12</td><td >
</td></tr><tr class="line_uncovered"><td class="line_num">13</td><td ><label class="keyword">class&nbsp;</label>UserCouponModel&nbsp;<label class="keyword">extends&nbsp;</label>BaseModel
</td></tr><tr class="line_unexcutable"><td class="line_num">14</td><td >{
</td></tr><tr class="line_covered"><td class="line_num">15</td><td>&nbsp;&nbsp;&nbsp;&nbsp;<label class="keyword">public&nbsp;</label><label class="keyword">static&nbsp;</label>$tableName&nbsp;=&nbsp;'cp_user_coupons';
</td></tr><tr class="line_unexcutable"><td class="line_num">16</td><td >
</td></tr><tr class="line_covered"><td class="line_num">17</td><td>&nbsp;&nbsp;&nbsp;&nbsp;<label class="keyword">CONST&nbsp;</label>CACHE_CONNECTION&nbsp;=&nbsp;'cache_coupon';
</td></tr><tr class="line_unexcutable"><td class="line_num">18</td><td >
</td></tr><tr class="line_unexcutable"><td class="line_num">19</td><td >&nbsp;&nbsp;&nbsp;&nbsp;<label class="keyword">CONST&nbsp;</label>CACHE_KEY_USER_COUPONS&nbsp;=&nbsp;'user_coupon:%s:%s';&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;userId:status
</td></tr><tr class="line_unexcutable"><td class="line_num">20</td><td >&nbsp;&nbsp;&nbsp;&nbsp;<label class="keyword">CONST&nbsp;</label>CACHE_KEY_USER_COUPON_BY_ORDERID&nbsp;=&nbsp;'user_coupon_by_orderid:%s';&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;userId:orderId
</td></tr><tr class="line_unexcutable"><td class="line_num">21</td><td >&nbsp;&nbsp;&nbsp;&nbsp;<label class="keyword">CONST&nbsp;</label>CACHE_KEY_USER_COUPON_BY_SCENARIO_VALUE&nbsp;=&nbsp;'user_coupon_by_scenarid_value:%s';&nbsp;&nbsp;&nbsp;//&nbsp;userId:code:value
</td></tr><tr class="line_unexcutable"><td class="line_num">22</td><td >&nbsp;&nbsp;&nbsp;&nbsp;<label class="keyword">CONST&nbsp;</label>CACHE_KEY_USER_COUPON_BY_SCENARIO_UID&nbsp;=&nbsp;'user_coupon_by_scenarid_uid:%s';&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;userId:code
</td></tr><tr class="line_unexcutable"><td class="line_num">23</td><td >
</td></tr><tr class="line_uncovered"><td class="line_num">24</td><td >&nbsp;&nbsp;&nbsp;&nbsp;<label class="keyword">CONST&nbsp;</label>K_USED&nbsp;=&nbsp;'USED';
</td></tr><tr class="line_uncovered"><td class="line_num">25</td><td >&nbsp;&nbsp;&nbsp;&nbsp;<label class="keyword">CONST&nbsp;</label>K_ACTIVED&nbsp;=&nbsp;'ACTIVED';
</td></tr><tr class="line_uncovered"><td class="line_num">26</td><td >&nbsp;&nbsp;&nbsp;&nbsp;<label class="keyword">CONST&nbsp;</label>K_STARTED&nbsp;=&nbsp;'STARTED';
</td></tr><tr class="line_uncovered"><td class="line_num">27</td><td >&nbsp;&nbsp;&nbsp;&nbsp;<label class="keyword">CONST&nbsp;</label>K_FINISHED&nbsp;=&nbsp;'FINISHED';
</td></tr><tr class="line_unexcutable"><td class="line_num">28</td><td >
</td></tr><tr class="line_uncovered"><td class="line_num">29</td><td >&nbsp;&nbsp;&nbsp;&nbsp;<label class="keyword">CONST&nbsp;</label>V_YES&nbsp;=&nbsp;1;
</td></tr><tr class="line_uncovered"><td class="line_num">30</td><td >&nbsp;&nbsp;&nbsp;&nbsp;<label class="keyword">CONST&nbsp;</label>V_NO&nbsp;=&nbsp;0;
</td></tr><tr class="line_uncovered"><td class="line_num">31</td><td >&nbsp;&nbsp;&nbsp;&nbsp;<label class="keyword">CONST&nbsp;</label>V_NONEED&nbsp;=&nbsp;2;
</td></tr><tr class="line_unexcutable"><td class="line_num">32</td><td >
</td></tr><tr class="line_uncovered"><td class="line_num">33</td><td >&nbsp;&nbsp;&nbsp;&nbsp;<label class="keyword">private&nbsp;</label><label class="keyword">static&nbsp;</label>$real_keys&nbsp;=&nbsp;[
</td></tr><tr class="line_uncovered"><td class="line_num">34</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'1012',
</td></tr><tr class="line_uncovered"><td class="line_num">35</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'1022'
</td></tr><tr class="line_uncovered"><td class="line_num">36</td><td >&nbsp;&nbsp;&nbsp;&nbsp;];
</td></tr><tr class="line_unexcutable"><td class="line_num">37</td><td >
</td></tr><tr class="line_unexcutable"><td class="line_num">38</td><td >&nbsp;&nbsp;&nbsp;&nbsp;/*<label class="keyword">private&nbsp;</label><label class="keyword">static&nbsp;</label>$sql_template&nbsp;=&nbsp;"SELECT&nbsp;
</td></tr><tr class="line_unexcutable"><td class="line_num">39</td><td >uc.id&nbsp;AS&nbsp;user_coupon_id,
</td></tr><tr class="line_unexcutable"><td class="line_num">40</td><td >uc.user_id,
</td></tr><tr class="line_unexcutable"><td class="line_num">41</td><td >uc.coupon_id,
</td></tr><tr class="line_unexcutable"><td class="line_num">42</td><td >uc.created_at,
</td></tr><tr class="line_unexcutable"><td class="line_num">43</td><td >uc.used,
</td></tr><tr class="line_unexcutable"><td class="line_num">44</td><td >uc.actived,
</td></tr><tr class="line_unexcutable"><td class="line_num">45</td><td >uc.scenario_code,
</td></tr><tr class="line_unexcutable"><td class="line_num">46</td><td >uc.scenario_value,
</td></tr><tr class="line_unexcutable"><td class="line_num">47</td><td >cp.name,
</td></tr><tr class="line_unexcutable"><td class="line_num">48</td><td >cp.description,
</td></tr><tr class="line_unexcutable"><td class="line_num">49</td><td >uc.order_id,
</td></tr><tr class="line_unexcutable"><td class="line_num">50</td><td >cp.cover,
</td></tr><tr class="line_unexcutable"><td class="line_num">51</td><td >cp.ttl,
</td></tr><tr class="line_unexcutable"><td class="line_num">52</td><td >cp.amount,
</td></tr><tr class="line_unexcutable"><td class="line_num">53</td><td >cp.is_discount,
</td></tr><tr class="line_unexcutable"><td class="line_num">54</td><td >cp.started_at,
</td></tr><tr class="line_unexcutable"><td class="line_num">55</td><td >cp.finished_at
</td></tr><tr class="line_unexcutable"><td class="line_num">56</td><td >FROM&nbsp;cp_user_coupons&nbsp;AS&nbsp;uc&nbsp;
</td></tr><tr class="line_unexcutable"><td class="line_num">57</td><td >INNER&nbsp;JOIN&nbsp;cp_coupon&nbsp;AS&nbsp;cp&nbsp;
</td></tr><tr class="line_unexcutable"><td class="line_num">58</td><td >ON&nbsp;uc.coupon_id&nbsp;=&nbsp;cp.id&nbsp;&nbsp;";*/
</td></tr><tr class="line_unexcutable"><td class="line_num">59</td><td >
</td></tr><tr class="line_uncovered"><td class="line_num">60</td><td >&nbsp;&nbsp;&nbsp;&nbsp;<label class="keyword">private&nbsp;</label><label class="keyword">static&nbsp;</label>$sql_template&nbsp;=&nbsp;"SELECT&nbsp;
</td></tr><tr class="line_uncovered"><td class="line_num">61</td><td >cp.id&nbsp;AS&nbsp;coupon_id,
</td></tr><tr class="line_uncovered"><td class="line_num">62</td><td >uc.id&nbsp;AS&nbsp;user_coupon_id,
</td></tr><tr class="line_uncovered"><td class="line_num">63</td><td >uc.user_id,
</td></tr><tr class="line_uncovered"><td class="line_num">64</td><td >uc.coupon_id,
</td></tr><tr class="line_uncovered"><td class="line_num">65</td><td >uc.created_at,
</td></tr><tr class="line_uncovered"><td class="line_num">66</td><td >uc.used,
</td></tr><tr class="line_uncovered"><td class="line_num">67</td><td >uc.actived,
</td></tr><tr class="line_uncovered"><td class="line_num">68</td><td >uc.scenario_code,
</td></tr><tr class="line_uncovered"><td class="line_num">69</td><td >uc.scenario_value,
</td></tr><tr class="line_uncovered"><td class="line_num">70</td><td >uc.order_id
</td></tr><tr class="line_uncovered"><td class="line_num">71</td><td >FROM&nbsp;cp_user_coupons&nbsp;AS&nbsp;uc&nbsp;
</td></tr><tr class="line_uncovered"><td class="line_num">72</td><td >INNER&nbsp;JOIN&nbsp;cp_coupon&nbsp;AS&nbsp;cp&nbsp;
</td></tr><tr class="line_uncovered"><td class="line_num">73</td><td >ON&nbsp;uc.coupon_id&nbsp;=&nbsp;cp.id&nbsp;&nbsp;";
</td></tr><tr class="line_unexcutable"><td class="line_num">74</td><td >
</td></tr><tr class="line_uncovered"><td class="line_num">75</td><td >&nbsp;&nbsp;&nbsp;&nbsp;<label class="keyword">protected&nbsp;</label><label class="keyword">static&nbsp;</label>$_inst&nbsp;=&nbsp;NULL;
</td></tr><tr class="line_unexcutable"><td class="line_num">76</td><td >
</td></tr><tr class="line_uncovered"><td class="line_num">77</td><td >&nbsp;&nbsp;&nbsp;&nbsp;<label class="keyword">public&nbsp;</label><label class="keyword">function&nbsp;</label>initialize()
</td></tr><tr class="line_unexcutable"><td class="line_num">78</td><td >&nbsp;&nbsp;&nbsp;&nbsp;{
</td></tr><tr class="line_uncovered"><td class="line_num">79</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this->setReadConnectionService('db_coupon_slave');
</td></tr><tr class="line_uncovered"><td class="line_num">80</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this->setWriteConnectionService('db_coupon');
</td></tr><tr class="line_unexcutable"><td class="line_num">81</td><td >&nbsp;&nbsp;&nbsp;&nbsp;}
</td></tr><tr class="line_unexcutable"><td class="line_num">82</td><td >
</td></tr><tr class="line_uncovered"><td class="line_num">83</td><td >&nbsp;&nbsp;&nbsp;&nbsp;<label class="keyword">public&nbsp;</label><label class="keyword">function&nbsp;</label>getSource()
</td></tr><tr class="line_unexcutable"><td class="line_num">84</td><td >&nbsp;&nbsp;&nbsp;&nbsp;{
</td></tr><tr class="line_uncovered"><td class="line_num">85</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<label class="keyword">return&nbsp;</label>'cp_user_coupons';
</td></tr><tr class="line_unexcutable"><td class="line_num">86</td><td >&nbsp;&nbsp;&nbsp;&nbsp;}
</td></tr><tr class="line_unexcutable"><td class="line_num">87</td><td >
</td></tr><tr class="line_uncovered"><td class="line_num">88</td><td >&nbsp;&nbsp;&nbsp;&nbsp;<label class="keyword">public&nbsp;</label><label class="keyword">static&nbsp;</label><label class="keyword">function&nbsp;</label>getInstance()
</td></tr><tr class="line_unexcutable"><td class="line_num">89</td><td >&nbsp;&nbsp;&nbsp;&nbsp;{
</td></tr><tr class="line_covered"><td class="line_num">90</td><td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<label class="keyword">if&nbsp;</label>(self::$_inst&nbsp;==&nbsp;NULL)&nbsp;{
</td></tr><tr class="line_covered"><td class="line_num">91</td><td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self::$_inst&nbsp;=&nbsp;<label class="keyword">new&nbsp;</label>UserCouponModel();
</td></tr><tr class="line_unexcutable"><td class="line_num">92</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
</td></tr><tr class="line_covered"><td class="line_num">93</td><td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<label class="keyword">return&nbsp;</label>self::$_inst;
</td></tr><tr class="line_unexcutable"><td class="line_num">94</td><td >&nbsp;&nbsp;&nbsp;&nbsp;}
</td></tr><tr class="line_unexcutable"><td class="line_num">95</td><td >
</td></tr><tr class="line_unexcutable"><td class="line_num">96</td><td >&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;!&nbsp;清除指定UID的所有優惠券
</td></tr><tr class="line_uncovered"><td class="line_num">97</td><td >&nbsp;&nbsp;&nbsp;&nbsp;<label class="keyword">public&nbsp;</label><label class="keyword">static&nbsp;</label><label class="keyword">function&nbsp;</label>clearUserCache($userId)
</td></tr><tr class="line_unexcutable"><td class="line_num">98</td><td >&nbsp;&nbsp;&nbsp;&nbsp;{
</td></tr><tr class="line_unexcutable"><td class="line_num">99</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;清空根據用戶UID查詢的緩存
</td></tr><tr class="line_uncovered"><td class="line_num">100</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<label class="keyword">foreach&nbsp;</label>(self::$real_keys&nbsp;<label class="keyword">as&nbsp;</label>$k&nbsp;=>&nbsp;$status)&nbsp;{
</td></tr><tr class="line_uncovered"><td class="line_num">101</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$cacheKey&nbsp;=&nbsp;sprintf(self::CACHE_KEY_USER_COUPONS,&nbsp;$userId,&nbsp;$status);
</td></tr><tr class="line_uncovered"><td class="line_num">102</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Di::getDefault()->get(self::CACHE_CONNECTION)->destroy($cacheKey);
</td></tr><tr class="line_unexcutable"><td class="line_num">103</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
</td></tr><tr class="line_unexcutable"><td class="line_num">104</td><td >
</td></tr><tr class="line_unexcutable"><td class="line_num">105</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;清空根據場景回溯的緩存
</td></tr><tr class="line_uncovered"><td class="line_num">106</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Di::getDefault()->get(self::CACHE_CONNECTION)->destroy(sprintf(self::CACHE_KEY_USER_COUPON_BY_ORDERID,&nbsp;$userId));
</td></tr><tr class="line_uncovered"><td class="line_num">107</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Di::getDefault()->get(self::CACHE_CONNECTION)->destroy(sprintf(self::CACHE_KEY_USER_COUPON_BY_SCENARIO_VALUE,&nbsp;$userId));
</td></tr><tr class="line_uncovered"><td class="line_num">108</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Di::getDefault()->get(self::CACHE_CONNECTION)->destroy(sprintf(self::CACHE_KEY_USER_COUPON_BY_SCENARIO_UID,&nbsp;$userId));
</td></tr><tr class="line_unexcutable"><td class="line_num">109</td><td >&nbsp;&nbsp;&nbsp;&nbsp;}
</td></tr><tr class="line_unexcutable"><td class="line_num">110</td><td >
</td></tr><tr class="line_uncovered"><td class="line_num">111</td><td >&nbsp;&nbsp;&nbsp;&nbsp;<label class="keyword">private&nbsp;</label><label class="keyword">function&nbsp;</label>buildWheres($statusParams)
</td></tr><tr class="line_unexcutable"><td class="line_num">112</td><td >&nbsp;&nbsp;&nbsp;&nbsp;{
</td></tr><tr class="line_uncovered"><td class="line_num">113</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$wheres&nbsp;=&nbsp;'';
</td></tr><tr class="line_uncovered"><td class="line_num">114</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<label class="keyword">switch&nbsp;</label>($statusParams[self::K_USED])&nbsp;{
</td></tr><tr class="line_uncovered"><td class="line_num">115</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<label class="keyword">case&nbsp;</label>self::V_YES:
</td></tr><tr class="line_uncovered"><td class="line_num">116</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$wheres&nbsp;.=&nbsp;'uc.used&nbsp;=&nbsp;1';
</td></tr><tr class="line_uncovered"><td class="line_num">117</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;
</td></tr><tr class="line_uncovered"><td class="line_num">118</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<label class="keyword">case&nbsp;</label>self::V_NO:
</td></tr><tr class="line_uncovered"><td class="line_num">119</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$wheres&nbsp;.=&nbsp;'uc.used&nbsp;=&nbsp;0';
</td></tr><tr class="line_uncovered"><td class="line_num">120</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;
</td></tr><tr class="line_uncovered"><td class="line_num">121</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<label class="keyword">case&nbsp;</label>self::V_NONEED:
</td></tr><tr class="line_uncovered"><td class="line_num">122</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;default:
</td></tr><tr class="line_uncovered"><td class="line_num">123</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$wheres&nbsp;.=&nbsp;'1=1';
</td></tr><tr class="line_uncovered"><td class="line_num">124</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;
</td></tr><tr class="line_unexcutable"><td class="line_num">125</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
</td></tr><tr class="line_unexcutable"><td class="line_num">126</td><td >
</td></tr><tr class="line_uncovered"><td class="line_num">127</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$wheres&nbsp;.=&nbsp;'&nbsp;AND&nbsp;';
</td></tr><tr class="line_unexcutable"><td class="line_num">128</td><td >
</td></tr><tr class="line_uncovered"><td class="line_num">129</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<label class="keyword">switch&nbsp;</label>($statusParams[self::K_ACTIVED])&nbsp;{
</td></tr><tr class="line_uncovered"><td class="line_num">130</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<label class="keyword">case&nbsp;</label>self::V_YES:
</td></tr><tr class="line_uncovered"><td class="line_num">131</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$wheres&nbsp;.=&nbsp;'uc.actived&nbsp;=&nbsp;1';
</td></tr><tr class="line_uncovered"><td class="line_num">132</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;
</td></tr><tr class="line_uncovered"><td class="line_num">133</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<label class="keyword">case&nbsp;</label>self::V_NO:
</td></tr><tr class="line_uncovered"><td class="line_num">134</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$wheres&nbsp;.=&nbsp;'uc.actived&nbsp;=&nbsp;0';
</td></tr><tr class="line_uncovered"><td class="line_num">135</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;
</td></tr><tr class="line_uncovered"><td class="line_num">136</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<label class="keyword">case&nbsp;</label>self::V_NONEED:
</td></tr><tr class="line_uncovered"><td class="line_num">137</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;default:
</td></tr><tr class="line_uncovered"><td class="line_num">138</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$wheres&nbsp;.=&nbsp;'1=1';
</td></tr><tr class="line_uncovered"><td class="line_num">139</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;
</td></tr><tr class="line_unexcutable"><td class="line_num">140</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
</td></tr><tr class="line_unexcutable"><td class="line_num">141</td><td >
</td></tr><tr class="line_uncovered"><td class="line_num">142</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$wheres&nbsp;.=&nbsp;'&nbsp;AND&nbsp;';
</td></tr><tr class="line_unexcutable"><td class="line_num">143</td><td >
</td></tr><tr class="line_uncovered"><td class="line_num">144</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$now&nbsp;=&nbsp;date("Y-m-d&nbsp;H:i:s");
</td></tr><tr class="line_uncovered"><td class="line_num">145</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<label class="keyword">switch&nbsp;</label>($statusParams[self::K_STARTED])&nbsp;{
</td></tr><tr class="line_uncovered"><td class="line_num">146</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<label class="keyword">case&nbsp;</label>self::V_YES:
</td></tr><tr class="line_unexcutable"><td class="line_num">147</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$wheres&nbsp;.=&nbsp;"cp.started_at&nbsp;<='"&nbsp;.&nbsp;$now&nbsp;.&nbsp;"'";&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;已开始
</td></tr><tr class="line_uncovered"><td class="line_num">148</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;
</td></tr><tr class="line_uncovered"><td class="line_num">149</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<label class="keyword">case&nbsp;</label>self::V_NO:
</td></tr><tr class="line_unexcutable"><td class="line_num">150</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$wheres&nbsp;.=&nbsp;"cp.started_at&nbsp;>'"&nbsp;.&nbsp;$now&nbsp;.&nbsp;"'";&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;未开始
</td></tr><tr class="line_uncovered"><td class="line_num">151</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;
</td></tr><tr class="line_uncovered"><td class="line_num">152</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<label class="keyword">case&nbsp;</label>self::V_NONEED:
</td></tr><tr class="line_uncovered"><td class="line_num">153</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;default:
</td></tr><tr class="line_uncovered"><td class="line_num">154</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$wheres&nbsp;.=&nbsp;'1=1';
</td></tr><tr class="line_uncovered"><td class="line_num">155</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;
</td></tr><tr class="line_unexcutable"><td class="line_num">156</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
</td></tr><tr class="line_unexcutable"><td class="line_num">157</td><td >
</td></tr><tr class="line_uncovered"><td class="line_num">158</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$wheres&nbsp;.=&nbsp;'&nbsp;AND&nbsp;';
</td></tr><tr class="line_unexcutable"><td class="line_num">159</td><td >
</td></tr><tr class="line_covered"><td class="line_num">160</td><td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<label class="keyword">switch&nbsp;</label>($statusParams[self::K_FINISHED])&nbsp;{
</td></tr><tr class="line_uncovered"><td class="line_num">161</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<label class="keyword">case&nbsp;</label>self::V_YES:
</td></tr><tr class="line_unexcutable"><td class="line_num">162</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$wheres&nbsp;.=&nbsp;"cp.finished_at&nbsp;<='"&nbsp;.&nbsp;$now&nbsp;.&nbsp;"'";&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;已结束
</td></tr><tr class="line_uncovered"><td class="line_num">163</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;
</td></tr><tr class="line_uncovered"><td class="line_num">164</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<label class="keyword">case&nbsp;</label>self::V_NO:
</td></tr><tr class="line_unexcutable"><td class="line_num">165</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$wheres&nbsp;.=&nbsp;"cp.finished_at&nbsp;>'"&nbsp;.&nbsp;$now&nbsp;.&nbsp;"'";&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;未结束
</td></tr><tr class="line_covered"><td class="line_num">166</td><td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;
</td></tr><tr class="line_uncovered"><td class="line_num">167</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<label class="keyword">case&nbsp;</label>self::V_NONEED:
</td></tr><tr class="line_uncovered"><td class="line_num">168</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;default:
</td></tr><tr class="line_uncovered"><td class="line_num">169</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$wheres&nbsp;.=&nbsp;'1=1';
</td></tr><tr class="line_uncovered"><td class="line_num">170</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;
</td></tr><tr class="line_unexcutable"><td class="line_num">171</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
</td></tr><tr class="line_unexcutable"><td class="line_num">172</td><td >
</td></tr><tr class="line_uncovered"><td class="line_num">173</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<label class="keyword">return&nbsp;</label>$wheres;
</td></tr><tr class="line_unexcutable"><td class="line_num">174</td><td >&nbsp;&nbsp;&nbsp;&nbsp;}
</td></tr><tr class="line_unexcutable"><td class="line_num">175</td><td >
</td></tr><tr class="line_uncovered"><td class="line_num">176</td><td >&nbsp;&nbsp;&nbsp;&nbsp;<label class="keyword">private&nbsp;</label><label class="keyword">function&nbsp;</label>queryBySql($sql,&nbsp;$cacheKey,&nbsp;$hashKey&nbsp;=&nbsp;'')
</td></tr><tr class="line_unexcutable"><td class="line_num">177</td><td >&nbsp;&nbsp;&nbsp;&nbsp;{
</td></tr><tr class="line_uncovered"><td class="line_num">178</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$records&nbsp;=&nbsp;$this->getReadConnection()->query($sql);
</td></tr><tr class="line_uncovered"><td class="line_num">179</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$resultSet&nbsp;=&nbsp;<label class="keyword">new&nbsp;</label>Resultset(NULL,&nbsp;$this,&nbsp;$records);
</td></tr><tr class="line_unexcutable"><td class="line_num">180</td><td >
</td></tr><tr class="line_uncovered"><td class="line_num">181</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$userCoupons&nbsp;=&nbsp;[];
</td></tr><tr class="line_uncovered"><td class="line_num">182</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<label class="keyword">foreach&nbsp;</label>($resultSet&nbsp;<label class="keyword">as&nbsp;</label>$row)&nbsp;{
</td></tr><tr class="line_uncovered"><td class="line_num">183</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$hashField&nbsp;=&nbsp;$row->user_coupon_id;
</td></tr><tr class="line_uncovered"><td class="line_num">184</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$userCoupons[$hashField]&nbsp;=&nbsp;[
</td></tr><tr class="line_uncovered"><td class="line_num">185</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'user_id'&nbsp;=>&nbsp;$row->user_id,
</td></tr><tr class="line_uncovered"><td class="line_num">186</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'user_coupon_id'&nbsp;=>&nbsp;$row->user_coupon_id,
</td></tr><tr class="line_uncovered"><td class="line_num">187</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'coupon_id'&nbsp;=>&nbsp;$row->coupon_id,
</td></tr><tr class="line_uncovered"><td class="line_num">188</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'actived'&nbsp;=>&nbsp;$row->actived,
</td></tr><tr class="line_uncovered"><td class="line_num">189</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'used'&nbsp;=>&nbsp;$row->used,
</td></tr><tr class="line_uncovered"><td class="line_num">190</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'created_at'&nbsp;=>&nbsp;$row->created_at
</td></tr><tr class="line_uncovered"><td class="line_num">191</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;];
</td></tr><tr class="line_unexcutable"><td class="line_num">192</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
</td></tr><tr class="line_unexcutable"><td class="line_num">193</td><td >
</td></tr><tr class="line_uncovered"><td class="line_num">194</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<label class="keyword">if&nbsp;</label>(empty($userCoupons))&nbsp;{
</td></tr><tr class="line_uncovered"><td class="line_num">195</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Di::getDefault()->get(self::CACHE_CONNECTION)->hashMultiSet($cacheKey,&nbsp;['empty'&nbsp;=>&nbsp;1]);
</td></tr><tr class="line_uncovered"><td class="line_num">196</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;<label class="keyword">else&nbsp;</label>{
</td></tr><tr class="line_uncovered"><td class="line_num">197</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<label class="keyword">if&nbsp;</label>(empty($hashKey))&nbsp;{
</td></tr><tr class="line_uncovered"><td class="line_num">198</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Di::getDefault()->get(self::CACHE_CONNECTION)->hashMultiSet($cacheKey,&nbsp;$userCoupons);
</td></tr><tr class="line_uncovered"><td class="line_num">199</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;<label class="keyword">else&nbsp;</label>{
</td></tr><tr class="line_uncovered"><td class="line_num">200</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Di::getDefault()->get(self::CACHE_CONNECTION)->hashSet($cacheKey,&nbsp;$hashKey,&nbsp;$userCoupons);
</td></tr><tr class="line_unexcutable"><td class="line_num">201</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
</td></tr><tr class="line_unexcutable"><td class="line_num">202</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
</td></tr><tr class="line_uncovered"><td class="line_num">203</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Di::getDefault()->get(self::CACHE_CONNECTION)->expire($cacheKey,&nbsp;\Cache\MyRedis::TODAY_TTL);
</td></tr><tr class="line_unexcutable"><td class="line_num">204</td><td >
</td></tr><tr class="line_uncovered"><td class="line_num">205</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<label class="keyword">return&nbsp;</label>$userCoupons;
</td></tr><tr class="line_unexcutable"><td class="line_num">206</td><td >&nbsp;&nbsp;&nbsp;&nbsp;}
</td></tr><tr class="line_unexcutable"><td class="line_num">207</td><td >
</td></tr><tr class="line_uncovered"><td class="line_num">208</td><td >&nbsp;&nbsp;&nbsp;&nbsp;<label class="keyword">private&nbsp;</label><label class="keyword">function&nbsp;</label>genStatusCacheInOrder($statusParams)
</td></tr><tr class="line_unexcutable"><td class="line_num">209</td><td >&nbsp;&nbsp;&nbsp;&nbsp;{
</td></tr><tr class="line_uncovered"><td class="line_num">210</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$str&nbsp;=&nbsp;'';
</td></tr><tr class="line_uncovered"><td class="line_num">211</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$params&nbsp;=&nbsp;$statusParams;
</td></tr><tr class="line_unexcutable"><td class="line_num">212</td><td >
</td></tr><tr class="line_uncovered"><td class="line_num">213</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$params[self::K_ACTIVED]&nbsp;=&nbsp;array_key_exists(self::K_ACTIVED,&nbsp;$params)&nbsp;?&nbsp;$params[self::K_ACTIVED]&nbsp;:&nbsp;self::V_NONEED;
</td></tr><tr class="line_uncovered"><td class="line_num">214</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$params[self::K_USED]&nbsp;=&nbsp;array_key_exists(self::K_USED,&nbsp;$params)&nbsp;?&nbsp;$params[self::K_USED]&nbsp;:&nbsp;self::V_NONEED;
</td></tr><tr class="line_uncovered"><td class="line_num">215</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$params[self::K_STARTED]&nbsp;=&nbsp;array_key_exists(self::K_STARTED,&nbsp;$params)&nbsp;?&nbsp;$params[self::K_STARTED]&nbsp;:&nbsp;self::V_NONEED;
</td></tr><tr class="line_uncovered"><td class="line_num">216</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$params[self::K_FINISHED]&nbsp;=&nbsp;array_key_exists(self::K_FINISHED,&nbsp;$params)&nbsp;?&nbsp;$params[self::K_FINISHED]&nbsp;:&nbsp;self::V_NONEED;
</td></tr><tr class="line_unexcutable"><td class="line_num">217</td><td >
</td></tr><tr class="line_uncovered"><td class="line_num">218</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$str&nbsp;.=&nbsp;$params[self::K_ACTIVED]&nbsp;.&nbsp;$params[self::K_USED]&nbsp;.&nbsp;$params[self::K_STARTED]&nbsp;.&nbsp;$params[self::K_FINISHED];
</td></tr><tr class="line_uncovered"><td class="line_num">219</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<label class="keyword">return&nbsp;</label>$str;
</td></tr><tr class="line_unexcutable"><td class="line_num">220</td><td >&nbsp;&nbsp;&nbsp;&nbsp;}
</td></tr><tr class="line_unexcutable"><td class="line_num">221</td><td >
</td></tr><tr class="line_unexcutable"><td class="line_num">222</td><td >
</td></tr><tr class="line_uncovered"><td class="line_num">223</td><td >&nbsp;&nbsp;&nbsp;&nbsp;<label class="keyword">public&nbsp;</label><label class="keyword">function&nbsp;</label>getCouponOfScenario($userId,&nbsp;$scenarioCode,&nbsp;$scenarioValue)
</td></tr><tr class="line_unexcutable"><td class="line_num">224</td><td >&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;&nbsp;&nbsp;
</td></tr><tr class="line_uncovered"><td class="line_num">225</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(intval($userId)<1&nbsp;||&nbsp;!$scenarioCode){
</td></tr><tr class="line_uncovered"><td class="line_num">226</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<label class="keyword">return&nbsp;</label>[];
</td></tr><tr class="line_unexcutable"><td class="line_num">227</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
</td></tr><tr class="line_unexcutable"><td class="line_num">228</td><td >
</td></tr><tr class="line_uncovered"><td class="line_num">229</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$hashKey&nbsp;=&nbsp;$scenarioCode&nbsp;.&nbsp;':'&nbsp;.&nbsp;$scenarioValue;
</td></tr><tr class="line_uncovered"><td class="line_num">230</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$cacheKey&nbsp;=&nbsp;sprintf(self::CACHE_KEY_USER_COUPON_BY_SCENARIO_VALUE,&nbsp;$userId);
</td></tr><tr class="line_uncovered"><td class="line_num">231</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$userCoupons&nbsp;=&nbsp;Di::getDefault()->get(self::CACHE_CONNECTION)->hashGet($cacheKey,&nbsp;$hashKey,&nbsp;TRUE);
</td></tr><tr class="line_unexcutable"><td class="line_num">232</td><td >
</td></tr><tr class="line_uncovered"><td class="line_num">233</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<label class="keyword">if&nbsp;</label>(isset($userCoupons['empty']))&nbsp;{
</td></tr><tr class="line_uncovered"><td class="line_num">234</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<label class="keyword">return&nbsp;</label>[];
</td></tr><tr class="line_unexcutable"><td class="line_num">235</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
</td></tr><tr class="line_unexcutable"><td class="line_num">236</td><td >
</td></tr><tr class="line_uncovered"><td class="line_num">237</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<label class="keyword">if&nbsp;</label>(!$userCoupons)&nbsp;{
</td></tr><tr class="line_uncovered"><td class="line_num">238</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$sql&nbsp;=&nbsp;self::$sql_template&nbsp;.&nbsp;"&nbsp;WHERE&nbsp;uc.user_id&nbsp;=&nbsp;{$userId}&nbsp;AND&nbsp;uc.scenario_code&nbsp;='{$scenarioCode}'&nbsp;AND&nbsp;uc.scenario_value&nbsp;='{$scenarioValue}'";
</td></tr><tr class="line_unexcutable"><td class="line_num">239</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;排序
</td></tr><tr class="line_uncovered"><td class="line_num">240</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$sql&nbsp;.=&nbsp;'&nbsp;order&nbsp;by&nbsp;uc.id&nbsp;desc';
</td></tr><tr class="line_unexcutable"><td class="line_num">241</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$userCoupons&nbsp;=&nbsp;$this->queryBySql($sql,&nbsp;$cacheKey,&nbsp;$hashKey);&nbsp;&nbsp;//&nbsp;会设置缓存
</td></tr><tr class="line_unexcutable"><td class="line_num">242</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;
</td></tr><tr class="line_unexcutable"><td class="line_num">243</td><td >
</td></tr><tr class="line_uncovered"><td class="line_num">244</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<label class="keyword">return&nbsp;</label>$this->verifyUserCouponsByCache($userCoupons);
</td></tr><tr class="line_unexcutable"><td class="line_num">245</td><td >&nbsp;&nbsp;&nbsp;&nbsp;}
</td></tr><tr class="line_unexcutable"><td class="line_num">246</td><td >
</td></tr><tr class="line_uncovered"><td class="line_num">247</td><td >&nbsp;&nbsp;&nbsp;&nbsp;<label class="keyword">protected&nbsp;</label><label class="keyword">function&nbsp;</label>verifyUserCouponsByCache($userCoupons){
</td></tr><tr class="line_uncovered"><td class="line_num">248</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$verifiedUserCoupons&nbsp;=&nbsp;[];
</td></tr><tr class="line_uncovered"><td class="line_num">249</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<label class="keyword">foreach&nbsp;</label>($userCoupons&nbsp;<label class="keyword">as&nbsp;</label>$userCouponId&nbsp;=>&nbsp;$userCoupon)&nbsp;{
</td></tr><tr class="line_uncovered"><td class="line_num">250</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$couponId&nbsp;=&nbsp;$userCoupon['coupon_id'];
</td></tr><tr class="line_uncovered"><td class="line_num">251</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$couponCacheKey&nbsp;=&nbsp;CouponModel::CACHE_KEY_COUPONS_ONLINE;
</td></tr><tr class="line_uncovered"><td class="line_num">252</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$coupon&nbsp;=&nbsp;Di::getDefault()->get(self::CACHE_CONNECTION)->hashGet($couponCacheKey,$couponId,TRUE);
</td></tr><tr class="line_unexcutable"><td class="line_num">253</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(empty($coupon)){&nbsp;//&nbsp;当前优惠券并不存在于缓存中（比如被清缓存）,则去数据库中找最新的
</td></tr><tr class="line_uncovered"><td class="line_num">254</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$coupon&nbsp;=&nbsp;CouponModel::queryOnlineCouponById($couponId);
</td></tr><tr class="line_uncovered"><td class="line_num">255</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(empty($coupon)){
</td></tr><tr class="line_unexcutable"><td class="line_num">256</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;仍然为空，说明优惠券已下线（online=0），那么这一条优惠券就不返回
</td></tr><tr class="line_uncovered"><td class="line_num">257</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;continue;
</td></tr><tr class="line_unexcutable"><td class="line_num">258</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
</td></tr><tr class="line_uncovered"><td class="line_num">259</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Di::getDefault()->get(self::CACHE_CONNECTION)->hashSet($couponCacheKey,&nbsp;$couponId,$coupon);
</td></tr><tr class="line_unexcutable"><td class="line_num">260</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
</td></tr><tr class="line_unexcutable"><td class="line_num">261</td><td >
</td></tr><tr class="line_unexcutable"><td class="line_num">262</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;针对&nbsp;绝对有效期/相对有效期&nbsp;的优惠券,&nbsp;设置其到期时间:&nbsp;left_time
</td></tr><tr class="line_uncovered"><td class="line_num">263</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<label class="keyword">if&nbsp;</label>(empty($coupon['ttl']))&nbsp;{
</td></tr><tr class="line_unexcutable"><td class="line_num">264</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;ttl为空，优惠券到期时间为绝对时间
</td></tr><tr class="line_uncovered"><td class="line_num">265</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$userCoupon['left_time']&nbsp;=&nbsp;strtotime($coupon['finished_at']);
</td></tr><tr class="line_uncovered"><td class="line_num">266</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;<label class="keyword">else&nbsp;</label>{
</td></tr><tr class="line_unexcutable"><td class="line_num">267</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;ttl不为空，按相对时间算（领取日期+生命周期）
</td></tr><tr class="line_uncovered"><td class="line_num">268</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$userCoupon['left_time']&nbsp;=&nbsp;strtotime($userCoupon['created_at'])&nbsp;+&nbsp;intval($coupon['ttl']);
</td></tr><tr class="line_unexcutable"><td class="line_num">269</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
</td></tr><tr class="line_unexcutable"><td class="line_num">270</td><td >
</td></tr><tr class="line_unexcutable"><td class="line_num">271</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;合并数据用于返回
</td></tr><tr class="line_uncovered"><td class="line_num">272</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$verifiedUserCoupons[$userCouponId]&nbsp;=&nbsp;[
</td></tr><tr class="line_uncovered"><td class="line_num">273</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'user_id'&nbsp;=>&nbsp;$userCoupon['user_id'],
</td></tr><tr class="line_uncovered"><td class="line_num">274</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'user_coupon_id'&nbsp;=>&nbsp;$userCoupon['user_coupon_id'],
</td></tr><tr class="line_uncovered"><td class="line_num">275</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'coupon_id'&nbsp;=>&nbsp;$userCoupon['coupon_id'],
</td></tr><tr class="line_uncovered"><td class="line_num">276</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'actived'&nbsp;=>&nbsp;$userCoupon['actived'],
</td></tr><tr class="line_uncovered"><td class="line_num">277</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'used'&nbsp;=>&nbsp;$userCoupon['used'],
</td></tr><tr class="line_uncovered"><td class="line_num">278</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'created_at'&nbsp;=>&nbsp;$userCoupon['created_at'],
</td></tr><tr class="line_uncovered"><td class="line_num">279</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'name'&nbsp;=>&nbsp;$coupon['name'],
</td></tr><tr class="line_uncovered"><td class="line_num">280</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'description'&nbsp;=>&nbsp;$coupon['description'],
</td></tr><tr class="line_uncovered"><td class="line_num">281</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'cover'&nbsp;=>&nbsp;$coupon['cover'],
</td></tr><tr class="line_uncovered"><td class="line_num">282</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'amount'&nbsp;=>&nbsp;$coupon['amount'],
</td></tr><tr class="line_uncovered"><td class="line_num">283</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'is_discount'&nbsp;=>&nbsp;$coupon['is_discount'],
</td></tr><tr class="line_uncovered"><td class="line_num">284</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'started_at'&nbsp;=>&nbsp;$coupon['started_at'],
</td></tr><tr class="line_uncovered"><td class="line_num">285</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'finished_at'&nbsp;=>&nbsp;$coupon['finished_at'],
</td></tr><tr class="line_uncovered"><td class="line_num">286</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'left_time'&nbsp;=>&nbsp;$userCoupon['left_time']
</td></tr><tr class="line_uncovered"><td class="line_num">287</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;];
</td></tr><tr class="line_unexcutable"><td class="line_num">288</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
</td></tr><tr class="line_uncovered"><td class="line_num">289</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<label class="keyword">return&nbsp;</label>$verifiedUserCoupons;
</td></tr><tr class="line_unexcutable"><td class="line_num">290</td><td >&nbsp;&nbsp;&nbsp;&nbsp;}
</td></tr><tr class="line_unexcutable"><td class="line_num">291</td><td >
</td></tr><tr class="line_uncovered"><td class="line_num">292</td><td >&nbsp;&nbsp;&nbsp;&nbsp;<label class="keyword">public&nbsp;</label><label class="keyword">function&nbsp;</label>getCouponOfScenarioByUid($userId,&nbsp;$scenarioCode)
</td></tr><tr class="line_unexcutable"><td class="line_num">293</td><td >&nbsp;&nbsp;&nbsp;&nbsp;{
</td></tr><tr class="line_unexcutable"><td class="line_num">294</td><td >
</td></tr><tr class="line_uncovered"><td class="line_num">295</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(intval($userId)<1&nbsp;||&nbsp;!$scenarioCode){
</td></tr><tr class="line_uncovered"><td class="line_num">296</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<label class="keyword">return&nbsp;</label>[];
</td></tr><tr class="line_unexcutable"><td class="line_num">297</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
</td></tr><tr class="line_unexcutable"><td class="line_num">298</td><td >
</td></tr><tr class="line_uncovered"><td class="line_num">299</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$cacheKey&nbsp;=&nbsp;sprintf(self::CACHE_KEY_USER_COUPON_BY_SCENARIO_UID,&nbsp;$userId);
</td></tr><tr class="line_uncovered"><td class="line_num">300</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$userCoupons&nbsp;=&nbsp;Di::getDefault()->get(self::CACHE_CONNECTION)->hashGet($cacheKey,&nbsp;$scenarioCode,&nbsp;TRUE);
</td></tr><tr class="line_uncovered"><td class="line_num">301</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<label class="keyword">if&nbsp;</label>(isset($userCoupons['empty']))&nbsp;{
</td></tr><tr class="line_uncovered"><td class="line_num">302</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<label class="keyword">return&nbsp;</label>[];
</td></tr><tr class="line_unexcutable"><td class="line_num">303</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
</td></tr><tr class="line_unexcutable"><td class="line_num">304</td><td >
</td></tr><tr class="line_uncovered"><td class="line_num">305</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<label class="keyword">if&nbsp;</label>(!$userCoupons)&nbsp;{
</td></tr><tr class="line_uncovered"><td class="line_num">306</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$sql&nbsp;=&nbsp;self::$sql_template&nbsp;.&nbsp;"&nbsp;WHERE&nbsp;uc.user_id&nbsp;=&nbsp;{$userId}&nbsp;AND&nbsp;uc.scenario_code&nbsp;='{$scenarioCode}'";
</td></tr><tr class="line_uncovered"><td class="line_num">307</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$sql&nbsp;.=&nbsp;'&nbsp;order&nbsp;by&nbsp;uc.id&nbsp;desc';
</td></tr><tr class="line_unexcutable"><td class="line_num">308</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$userCoupons&nbsp;=&nbsp;$this->queryBySql($sql,&nbsp;$cacheKey);&nbsp;&nbsp;//&nbsp;会设置缓存
</td></tr><tr class="line_unexcutable"><td class="line_num">309</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;
</td></tr><tr class="line_unexcutable"><td class="line_num">310</td><td >
</td></tr><tr class="line_uncovered"><td class="line_num">311</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<label class="keyword">return&nbsp;</label>$this->verifyUserCouponsByCache($userCoupons);
</td></tr><tr class="line_unexcutable"><td class="line_num">312</td><td >&nbsp;&nbsp;&nbsp;&nbsp;}
</td></tr><tr class="line_unexcutable"><td class="line_num">313</td><td >
</td></tr><tr class="line_uncovered"><td class="line_num">314</td><td >&nbsp;&nbsp;&nbsp;&nbsp;<label class="keyword">public&nbsp;</label><label class="keyword">function&nbsp;</label>getCouponDetailByOrderId($userId,&nbsp;$orderId)
</td></tr><tr class="line_unexcutable"><td class="line_num">315</td><td >&nbsp;&nbsp;&nbsp;&nbsp;{
</td></tr><tr class="line_uncovered"><td class="line_num">316</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(intval($userId)<1){
</td></tr><tr class="line_uncovered"><td class="line_num">317</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<label class="keyword">return&nbsp;</label>[];
</td></tr><tr class="line_unexcutable"><td class="line_num">318</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
</td></tr><tr class="line_unexcutable"><td class="line_num">319</td><td >
</td></tr><tr class="line_uncovered"><td class="line_num">320</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$cacheKey&nbsp;=&nbsp;sprintf(self::CACHE_KEY_USER_COUPON_BY_ORDERID,&nbsp;$userId);
</td></tr><tr class="line_uncovered"><td class="line_num">321</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$userCoupons&nbsp;=&nbsp;Di::getDefault()->get(self::CACHE_CONNECTION)->hashGet($cacheKey,&nbsp;$orderId,&nbsp;TRUE);
</td></tr><tr class="line_unexcutable"><td class="line_num">322</td><td >
</td></tr><tr class="line_uncovered"><td class="line_num">323</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<label class="keyword">if&nbsp;</label>(!$userCoupons)&nbsp;{
</td></tr><tr class="line_uncovered"><td class="line_num">324</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$sql&nbsp;=&nbsp;self::$sql_template&nbsp;.&nbsp;"&nbsp;WHERE&nbsp;uc.user_id&nbsp;=&nbsp;{$userId}&nbsp;AND&nbsp;uc.order_id&nbsp;='{$orderId}'";
</td></tr><tr class="line_unexcutable"><td class="line_num">325</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$userCoupons&nbsp;=&nbsp;$this->queryBySql($sql,&nbsp;$cacheKey,&nbsp;$orderId);&nbsp;&nbsp;//&nbsp;会设置缓存
</td></tr><tr class="line_unexcutable"><td class="line_num">326</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
</td></tr><tr class="line_unexcutable"><td class="line_num">327</td><td >
</td></tr><tr class="line_uncovered"><td class="line_num">328</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<label class="keyword">return&nbsp;</label>$this->verifyUserCouponsByCache($userCoupons);
</td></tr><tr class="line_unexcutable"><td class="line_num">329</td><td >&nbsp;&nbsp;&nbsp;&nbsp;}
</td></tr><tr class="line_unexcutable"><td class="line_num">330</td><td >
</td></tr><tr class="line_uncovered"><td class="line_num">331</td><td >&nbsp;&nbsp;&nbsp;&nbsp;<label class="keyword">public&nbsp;</label><label class="keyword">function&nbsp;</label>getUserCouponsByStatus($userId,&nbsp;$statusParams&nbsp;=&nbsp;NULL)
</td></tr><tr class="line_unexcutable"><td class="line_num">332</td><td >&nbsp;&nbsp;&nbsp;&nbsp;{
</td></tr><tr class="line_uncovered"><td class="line_num">333</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(intval($userId)<1&nbsp;||&nbsp;NULL&nbsp;==&nbsp;$statusParams){
</td></tr><tr class="line_uncovered"><td class="line_num">334</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<label class="keyword">return&nbsp;</label>[];
</td></tr><tr class="line_unexcutable"><td class="line_num">335</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
</td></tr><tr class="line_unexcutable"><td class="line_num">336</td><td >
</td></tr><tr class="line_uncovered"><td class="line_num">337</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$cacheKey&nbsp;=&nbsp;sprintf(self::CACHE_KEY_USER_COUPONS,&nbsp;$userId,&nbsp;$this->genStatusCacheInOrder($statusParams));
</td></tr><tr class="line_uncovered"><td class="line_num">338</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$userCoupons&nbsp;=&nbsp;Di::getDefault()->get(self::CACHE_CONNECTION)->hashGetAll($cacheKey);
</td></tr><tr class="line_uncovered"><td class="line_num">339</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<label class="keyword">if&nbsp;</label>(isset($userCoupons['empty']))&nbsp;{
</td></tr><tr class="line_uncovered"><td class="line_num">340</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<label class="keyword">return&nbsp;</label>[];
</td></tr><tr class="line_unexcutable"><td class="line_num">341</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
</td></tr><tr class="line_unexcutable"><td class="line_num">342</td><td >
</td></tr><tr class="line_uncovered"><td class="line_num">343</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<label class="keyword">if&nbsp;</label>(!$userCoupons)&nbsp;{
</td></tr><tr class="line_uncovered"><td class="line_num">344</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$wheres&nbsp;=&nbsp;$this->buildWheres($statusParams)&nbsp;.&nbsp;"&nbsp;AND&nbsp;cp.online=1&nbsp;AND&nbsp;uc.user_id={$userId}";
</td></tr><tr class="line_uncovered"><td class="line_num">345</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$sql&nbsp;=&nbsp;self::$sql_template&nbsp;.&nbsp;"&nbsp;WHERE&nbsp;{$wheres}";
</td></tr><tr class="line_unexcutable"><td class="line_num">346</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$userCoupons&nbsp;=&nbsp;$this->queryBySql($sql,&nbsp;$cacheKey);&nbsp;&nbsp;//&nbsp;会设置缓存
</td></tr><tr class="line_unexcutable"><td class="line_num">347</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;
</td></tr><tr class="line_unexcutable"><td class="line_num">348</td><td >
</td></tr><tr class="line_uncovered"><td class="line_num">349</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<label class="keyword">return&nbsp;</label>$this->verifyUserCouponsByCache($userCoupons);
</td></tr><tr class="line_unexcutable"><td class="line_num">350</td><td >&nbsp;&nbsp;&nbsp;&nbsp;}
</td></tr><tr class="line_unexcutable"><td class="line_num">351</td><td >
</td></tr><tr class="line_uncovered"><td class="line_num">352</td><td >&nbsp;&nbsp;&nbsp;&nbsp;<label class="keyword">public&nbsp;</label><label class="keyword">function&nbsp;</label>sendCoupons($userId,&nbsp;$couponList,&nbsp;$scenarioCode,&nbsp;$scenarioValue)
</td></tr><tr class="line_unexcutable"><td class="line_num">353</td><td >&nbsp;&nbsp;&nbsp;&nbsp;{
</td></tr><tr class="line_uncovered"><td class="line_num">354</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$success&nbsp;=&nbsp;TRUE;
</td></tr><tr class="line_unexcutable"><td class="line_num">355</td><td >
</td></tr><tr class="line_uncovered"><td class="line_num">356</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<label class="keyword">if&nbsp;</label>(empty($couponList)&nbsp;||&nbsp;empty($scenarioCode))&nbsp;{
</td></tr><tr class="line_uncovered"><td class="line_num">357</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<label class="keyword">return&nbsp;</label>FALSE;
</td></tr><tr class="line_unexcutable"><td class="line_num">358</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
</td></tr><tr class="line_unexcutable"><td class="line_num">359</td><td >
</td></tr><tr class="line_uncovered"><td class="line_num">360</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<label class="keyword">if&nbsp;</label>(intval($userId)&nbsp;<=&nbsp;0)&nbsp;{
</td></tr><tr class="line_uncovered"><td class="line_num">361</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<label class="keyword">return&nbsp;</label>FALSE;
</td></tr><tr class="line_unexcutable"><td class="line_num">362</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
</td></tr><tr class="line_unexcutable"><td class="line_num">363</td><td >
</td></tr><tr class="line_uncovered"><td class="line_num">364</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<label class="keyword">if&nbsp;</label>(empty($scenarioValue))&nbsp;{
</td></tr><tr class="line_uncovered"><td class="line_num">365</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$scenarioValue&nbsp;=&nbsp;'-';
</td></tr><tr class="line_unexcutable"><td class="line_num">366</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
</td></tr><tr class="line_unexcutable"><td class="line_num">367</td><td >
</td></tr><tr class="line_unexcutable"><td class="line_num">368</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$active&nbsp;=&nbsp;1;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;默认自动激活！
</td></tr><tr class="line_uncovered"><td class="line_num">369</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$scenario&nbsp;=&nbsp;ScenarioModel::getDetail($scenarioCode);
</td></tr><tr class="line_uncovered"><td class="line_num">370</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<label class="keyword">if&nbsp;</label>(!empty($scenario)&nbsp;&&&nbsp;isset($scenario['active']))&nbsp;{
</td></tr><tr class="line_unexcutable"><td class="line_num">371</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$active&nbsp;=&nbsp;intval($scenario['active']);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;是否自动激活
</td></tr><tr class="line_unexcutable"><td class="line_num">372</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
</td></tr><tr class="line_unexcutable"><td class="line_num">373</td><td >
</td></tr><tr class="line_uncovered"><td class="line_num">374</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<label class="keyword">foreach&nbsp;</label>($couponList&nbsp;<label class="keyword">as&nbsp;</label>$key&nbsp;=>&nbsp;$couponId)&nbsp;{
</td></tr><tr class="line_uncovered"><td class="line_num">375</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this->getWriteConnection()->begin();
</td></tr><tr class="line_uncovered"><td class="line_num">376</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<label class="keyword">try&nbsp;</label>{
</td></tr><tr class="line_uncovered"><td class="line_num">377</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$newUserCoupon&nbsp;=&nbsp;<label class="keyword">new&nbsp;</label>UserCouponModel();
</td></tr><tr class="line_uncovered"><td class="line_num">378</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$newUserCoupon->user_id&nbsp;=&nbsp;intval($userId);
</td></tr><tr class="line_uncovered"><td class="line_num">379</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$newUserCoupon->coupon_id&nbsp;=&nbsp;intval($couponId);
</td></tr><tr class="line_uncovered"><td class="line_num">380</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$newUserCoupon->used&nbsp;=&nbsp;0;
</td></tr><tr class="line_uncovered"><td class="line_num">381</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$newUserCoupon->order_id&nbsp;=&nbsp;0;
</td></tr><tr class="line_uncovered"><td class="line_num">382</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$newUserCoupon->actived&nbsp;=&nbsp;$active;
</td></tr><tr class="line_uncovered"><td class="line_num">383</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$newUserCoupon->scenario_code&nbsp;=&nbsp;$scenarioCode;
</td></tr><tr class="line_uncovered"><td class="line_num">384</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$newUserCoupon->scenario_value&nbsp;=&nbsp;$scenarioValue;
</td></tr><tr class="line_unexcutable"><td class="line_num">385</td><td >
</td></tr><tr class="line_uncovered"><td class="line_num">386</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<label class="keyword">if&nbsp;</label>($newUserCoupon->save()&nbsp;==&nbsp;FALSE)&nbsp;{
</td></tr><tr class="line_unexcutable"><td class="line_num">387</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;插入失败
</td></tr><tr class="line_uncovered"><td class="line_num">388</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\Phalcon\DI::getDefault()->get('log')->error('insert&nbsp;user&nbsp;coupon&nbsp;failed\nUserId:'&nbsp;.&nbsp;$userId&nbsp;.&nbsp;'&nbsp;Coupons:'&nbsp;.&nbsp;json_encode($couponId));
</td></tr><tr class="line_uncovered"><td class="line_num">389</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$success&nbsp;=&nbsp;FALSE;
</td></tr><tr class="line_uncovered"><td class="line_num">390</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this->getWriteConnection()->rollback();
</td></tr><tr class="line_uncovered"><td class="line_num">391</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;
</td></tr><tr class="line_uncovered"><td class="line_num">392</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;<label class="keyword">else&nbsp;</label>{
</td></tr><tr class="line_unexcutable"><td class="line_num">393</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;插入成功，继续插入Notice
</td></tr><tr class="line_uncovered"><td class="line_num">394</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$newNotice&nbsp;=&nbsp;<label class="keyword">new&nbsp;</label>NoticeModel();
</td></tr><tr class="line_uncovered"><td class="line_num">395</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$newNotice->day&nbsp;=&nbsp;intval(date("Ymd"));
</td></tr><tr class="line_uncovered"><td class="line_num">396</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$newNotice->coupon_id&nbsp;=&nbsp;intval($couponId);
</td></tr><tr class="line_uncovered"><td class="line_num">397</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$newNotice->user_id&nbsp;=&nbsp;intval($userId);
</td></tr><tr class="line_unexcutable"><td class="line_num">398</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//$newNotice->user_id&nbsp;=&nbsp;'TEXT';&nbsp;//&nbsp;造成插入失败&nbsp;&nbsp;<label class="keyword">f<label class="keyword">or&nbsp;</label></label>test
</td></tr><tr class="line_uncovered"><td class="line_num">399</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<label class="keyword">if&nbsp;</label>($newNotice->save()&nbsp;==&nbsp;FALSE)&nbsp;{
</td></tr><tr class="line_unexcutable"><td class="line_num">400</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;插入失败
</td></tr><tr class="line_uncovered"><td class="line_num">401</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\Phalcon\DI::getDefault()->get('log')->error('insert&nbsp;user&nbsp;coupon&nbsp;failed\nUserId:'&nbsp;.&nbsp;$userId&nbsp;.&nbsp;'&nbsp;Coupons:'&nbsp;.&nbsp;json_encode($couponId));
</td></tr><tr class="line_uncovered"><td class="line_num">402</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$success&nbsp;=&nbsp;FALSE;
</td></tr><tr class="line_uncovered"><td class="line_num">403</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this->getWriteConnection()->rollback();
</td></tr><tr class="line_uncovered"><td class="line_num">404</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;
</td></tr><tr class="line_unexcutable"><td class="line_num">405</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
</td></tr><tr class="line_unexcutable"><td class="line_num">406</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
</td></tr><tr class="line_unexcutable"><td class="line_num">407</td><td >
</td></tr><tr class="line_uncovered"><td class="line_num">408</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this->getWriteConnection()->commit();
</td></tr><tr class="line_uncovered"><td class="line_num">409</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;<label class="keyword">catch&nbsp;</label>(Exception&nbsp;$e)&nbsp;{
</td></tr><tr class="line_uncovered"><td class="line_num">410</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\Phalcon\DI::getDefault()->get('log')->error($e->getMessage());
</td></tr><tr class="line_uncovered"><td class="line_num">411</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this->getWriteConnection()->rollback();
</td></tr><tr class="line_uncovered"><td class="line_num">412</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<label class="keyword">return&nbsp;</label>FALSE;
</td></tr><tr class="line_unexcutable"><td class="line_num">413</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
</td></tr><tr class="line_unexcutable"><td class="line_num">414</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
</td></tr><tr class="line_uncovered"><td class="line_num">415</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<label class="keyword">return&nbsp;</label>$success;
</td></tr><tr class="line_unexcutable"><td class="line_num">416</td><td >&nbsp;&nbsp;&nbsp;&nbsp;}
</td></tr><tr class="line_unexcutable"><td class="line_num">417</td><td >
</td></tr><tr class="line_unexcutable"><td class="line_num">418</td><td >&nbsp;&nbsp;&nbsp;&nbsp;/**
</td></tr><tr class="line_unexcutable"><td class="line_num">419</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@desc&nbsp;更新优惠券
</td></tr><tr class="line_unexcutable"><td class="line_num">420</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;$userCouponId
</td></tr><tr class="line_unexcutable"><td class="line_num">421</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;$orderId
</td></tr><tr class="line_unexcutable"><td class="line_num">422</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@<label class="keyword">return&nbsp;</label>array
</td></tr><tr class="line_unexcutable"><td class="line_num">423</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/
</td></tr><tr class="line_uncovered"><td class="line_num">424</td><td >&nbsp;&nbsp;&nbsp;&nbsp;<label class="keyword">public&nbsp;</label><label class="keyword">static&nbsp;</label><label class="keyword">function&nbsp;</label>setCouponUsed($userCouponId,&nbsp;$orderId&nbsp;=&nbsp;0)
</td></tr><tr class="line_unexcutable"><td class="line_num">425</td><td >&nbsp;&nbsp;&nbsp;&nbsp;{
</td></tr><tr class="line_uncovered"><td class="line_num">426</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<label class="keyword">if&nbsp;</label>(intval($userCouponId))&nbsp;{
</td></tr><tr class="line_uncovered"><td class="line_num">427</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$record&nbsp;=&nbsp;[
</td></tr><tr class="line_uncovered"><td class="line_num">428</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'used'&nbsp;=>&nbsp;1,
</td></tr><tr class="line_uncovered"><td class="line_num">429</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'order_id'&nbsp;=>&nbsp;$orderId,
</td></tr><tr class="line_uncovered"><td class="line_num">430</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'updated_at'&nbsp;=>&nbsp;date('Y-m-d&nbsp;H:i:s'),
</td></tr><tr class="line_uncovered"><td class="line_num">431</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;];
</td></tr><tr class="line_unexcutable"><td class="line_num">432</td><td >
</td></tr><tr class="line_uncovered"><td class="line_num">433</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$where&nbsp;=&nbsp;[
</td></tr><tr class="line_uncovered"><td class="line_num">434</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'id'&nbsp;=>&nbsp;$userCouponId,
</td></tr><tr class="line_uncovered"><td class="line_num">435</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;];
</td></tr><tr class="line_uncovered"><td class="line_num">436</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<label class="keyword">return&nbsp;</label>self::updateRecord($record,&nbsp;$where);
</td></tr><tr class="line_unexcutable"><td class="line_num">437</td><td >
</td></tr><tr class="line_uncovered"><td class="line_num">438</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;<label class="keyword">else&nbsp;</label>{
</td></tr><tr class="line_uncovered"><td class="line_num">439</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<label class="keyword">return&nbsp;</label>FALSE;
</td></tr><tr class="line_unexcutable"><td class="line_num">440</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
</td></tr><tr class="line_unexcutable"><td class="line_num">441</td><td >&nbsp;&nbsp;&nbsp;&nbsp;}
</td></tr><tr class="line_unexcutable"><td class="line_num">442</td><td >
</td></tr><tr class="line_unexcutable"><td class="line_num">443</td><td >&nbsp;&nbsp;&nbsp;&nbsp;/**
</td></tr><tr class="line_unexcutable"><td class="line_num">444</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@desc&nbsp;根据用户ID&nbsp;和订单ID恢复优惠券
</td></tr><tr class="line_unexcutable"><td class="line_num">445</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;$userId
</td></tr><tr class="line_unexcutable"><td class="line_num">446</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;$orderId
</td></tr><tr class="line_unexcutable"><td class="line_num">447</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@<label class="keyword">return&nbsp;</label>bool
</td></tr><tr class="line_unexcutable"><td class="line_num">448</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/
</td></tr><tr class="line_uncovered"><td class="line_num">449</td><td >&nbsp;&nbsp;&nbsp;&nbsp;<label class="keyword">public&nbsp;</label><label class="keyword">static&nbsp;</label><label class="keyword">function&nbsp;</label>setCouponRestoredWithUserIdAndOrderId($userId,&nbsp;$orderId)
</td></tr><tr class="line_unexcutable"><td class="line_num">450</td><td >&nbsp;&nbsp;&nbsp;&nbsp;{
</td></tr><tr class="line_uncovered"><td class="line_num">451</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<label class="keyword">if&nbsp;</label>($userId&nbsp;&&&nbsp;$orderId)&nbsp;{
</td></tr><tr class="line_uncovered"><td class="line_num">452</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$record&nbsp;=&nbsp;[
</td></tr><tr class="line_uncovered"><td class="line_num">453</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'used'&nbsp;=>&nbsp;0,
</td></tr><tr class="line_uncovered"><td class="line_num">454</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'order_id'&nbsp;=>&nbsp;0,
</td></tr><tr class="line_uncovered"><td class="line_num">455</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'updated_at'&nbsp;=>&nbsp;date('Y-m-d&nbsp;H:i:s'),
</td></tr><tr class="line_uncovered"><td class="line_num">456</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;];
</td></tr><tr class="line_unexcutable"><td class="line_num">457</td><td >
</td></tr><tr class="line_uncovered"><td class="line_num">458</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$where&nbsp;=&nbsp;[
</td></tr><tr class="line_uncovered"><td class="line_num">459</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'user_id'&nbsp;=>&nbsp;$userId,
</td></tr><tr class="line_uncovered"><td class="line_num">460</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'order_id'&nbsp;=>&nbsp;$orderId,
</td></tr><tr class="line_uncovered"><td class="line_num">461</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;];
</td></tr><tr class="line_uncovered"><td class="line_num">462</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<label class="keyword">return&nbsp;</label>self::updateRecord($record,&nbsp;$where);
</td></tr><tr class="line_unexcutable"><td class="line_num">463</td><td >
</td></tr><tr class="line_uncovered"><td class="line_num">464</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;<label class="keyword">else&nbsp;</label>{
</td></tr><tr class="line_uncovered"><td class="line_num">465</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<label class="keyword">return&nbsp;</label>FALSE;
</td></tr><tr class="line_unexcutable"><td class="line_num">466</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
</td></tr><tr class="line_unexcutable"><td class="line_num">467</td><td >&nbsp;&nbsp;&nbsp;&nbsp;}
</td></tr><tr class="line_unexcutable"><td class="line_num">468</td><td >
</td></tr><tr class="line_unexcutable"><td class="line_num">469</td><td >&nbsp;&nbsp;&nbsp;&nbsp;/**
</td></tr><tr class="line_unexcutable"><td class="line_num">470</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@desc&nbsp;根据优惠券ID恢复优惠券
</td></tr><tr class="line_unexcutable"><td class="line_num">471</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;$userId
</td></tr><tr class="line_unexcutable"><td class="line_num">472</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;$userCouponId
</td></tr><tr class="line_unexcutable"><td class="line_num">473</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@<label class="keyword">return&nbsp;</label>bool
</td></tr><tr class="line_unexcutable"><td class="line_num">474</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/
</td></tr><tr class="line_uncovered"><td class="line_num">475</td><td >&nbsp;&nbsp;&nbsp;&nbsp;<label class="keyword">public&nbsp;</label><label class="keyword">static&nbsp;</label><label class="keyword">function&nbsp;</label>setCouponActived($userId,&nbsp;$userCouponId)
</td></tr><tr class="line_unexcutable"><td class="line_num">476</td><td >&nbsp;&nbsp;&nbsp;&nbsp;{
</td></tr><tr class="line_uncovered"><td class="line_num">477</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<label class="keyword">if&nbsp;</label>($userId&nbsp;&&&nbsp;$userCouponId)&nbsp;{
</td></tr><tr class="line_uncovered"><td class="line_num">478</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$record&nbsp;=&nbsp;[
</td></tr><tr class="line_uncovered"><td class="line_num">479</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'actived'&nbsp;=>&nbsp;1,
</td></tr><tr class="line_uncovered"><td class="line_num">480</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'updated_at'&nbsp;=>&nbsp;date('Y-m-d&nbsp;H:i:s'),
</td></tr><tr class="line_uncovered"><td class="line_num">481</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;];
</td></tr><tr class="line_unexcutable"><td class="line_num">482</td><td >
</td></tr><tr class="line_uncovered"><td class="line_num">483</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$where&nbsp;=&nbsp;[
</td></tr><tr class="line_uncovered"><td class="line_num">484</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'user_id'&nbsp;=>&nbsp;$userId,
</td></tr><tr class="line_uncovered"><td class="line_num">485</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'id'&nbsp;=>&nbsp;$userCouponId,
</td></tr><tr class="line_uncovered"><td class="line_num">486</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;];
</td></tr><tr class="line_uncovered"><td class="line_num">487</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<label class="keyword">return&nbsp;</label>self::updateRecord($record,&nbsp;$where);
</td></tr><tr class="line_unexcutable"><td class="line_num">488</td><td >
</td></tr><tr class="line_uncovered"><td class="line_num">489</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;<label class="keyword">else&nbsp;</label>{
</td></tr><tr class="line_uncovered"><td class="line_num">490</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<label class="keyword">return&nbsp;</label>FALSE;
</td></tr><tr class="line_unexcutable"><td class="line_num">491</td><td >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
</td></tr><tr class="line_unexcutable"><td class="line_num">492</td><td >&nbsp;&nbsp;&nbsp;&nbsp;}
</td></tr><tr class="line_unexcutable"><td class="line_num">493</td><td >}
</td></tr><tr class="line_unexcutable"><td class="line_num">494</td><td ></td></tr></table>
</body>
</html>
